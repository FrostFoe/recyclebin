import React, { useState, useEffect, useRef, useMemo, useCallback, useReducer } from 'react';
import { 
  Menu, Search, ArrowLeft, Phone, MoreVertical, Paperclip, 
  Smile, Send, Mic, Check, CheckCheck, ChevronDown, X,
  Archive, Trash2, VolumeX, CheckCircle, Settings, Users, 
  Bookmark, CircleHelp, UserPlus, LogOut, Pin, Reply,
  Image as ImageIcon, Moon, Sun, StopCircle, Info, Forward,
  Camera, Bell, Lock, Edit2, Edit3, Megaphone, Ban, Shield, Plus,
  BarChart2, Sticker, Film, PhoneCall, PhoneOff, Video, Grid,
  Clock, Flame, FolderPlus, Eye, Play, Pause, Gamepad2, Languages, Palette, KeyRound,
  PenTool, Eraser, Download, User, Link as LinkIcon, Copy, BellOff, QrCode, Bot, EyeOff
} from 'lucide-react';

// --- Data Types & Interfaces ---
interface EmojiReaction {
  emoji: string;
  count: number;
  me: boolean;
}

interface PollOption {
  id: number;
  text: string;
  votes: number;
  voted: boolean;
}

interface Message {
  id: number;
  text?: string;
  type?: string;
  sender: string;
  time: string;
  status: 'sent' | 'read' | 'delivered';
  reactions?: EmojiReaction[];
  senderName?: string;
  question?: string;
  options?: PollOption[];
  views?: number;
  fileUrl?: string;
  isForwarded?: boolean;
  replyTo?: Message;
  isEdited?: boolean;
  expiresAt?: number;
  selfDestructTime?: number;
  gameState?: {
    board: string[];
    xIsNext: boolean;
    winner: string | null;
  };
  isScheduled?: boolean;
  file?: File;
}

interface Chat {
  id: number;
  name: string;
  avatar: string;
  type: 'private' | 'group' | 'channel' | 'bot';
  role: string;
  lastMessage: string;
  time: string;
  unread: number;
  online: boolean;
  archived: boolean;
  muted: boolean;
  blocked: boolean;
  pinnedMessageId: number | null;
  messages: Message[];
  verified?: boolean;
  members?: number;
  subscribers?: string;
  description?: string;
  link?: string;
  bio?: string;
  mobile?: string;
  lastSeen?: string;
}

interface Folder {
  id: string;
  name: string;
  type: 'all' | 'private' | 'group' | 'channel';
  locked: boolean;
}

interface Profile {
  name: string;
  bio: string;
  phone: string;
  username: string;
}

interface AccentColor {
  name: string;
  value: string;
}

interface Story {
  id: number;
  user: string;
  avatar: string;
  image: string;
  viewed: boolean;
  time: string;
}

interface Contact {
  id: number;
  name: string;
  avatar: string;
  bio: string;
}

// --- Constants ---
const COMMON_EMOJIS = ["ðŸ‘", "â¤ï¸", "ðŸ˜‚", "ðŸ˜®", "ðŸ˜¢", "ðŸ”¥", "ðŸŽ‰", "ðŸ’©", "ðŸ¥°", "ðŸ¤”", "ðŸ‘‹", "ðŸ™", "ðŸ‘€", "âœ¨"];

const ACCENT_COLORS: AccentColor[] = [
  { name: "Blue", value: "#3390ec" },
  { name: "Purple", value: "#8774e1" },
  { name: "Green", value: "#46c46e" },
  { name: "Orange", value: "#e58e39" },
  { name: "Pink", value: "#f267ad" },
  { name: "Red", value: "#e53935" },
];

const STICKERS = [
  "https://cdn-icons-png.flaticon.com/128/9408/9408166.png",
  "https://cdn-icons-png.flaticon.com/128/9408/9408201.png",
  "https://cdn-icons-png.flaticon.com/128/9408/9408175.png",
  "https://cdn-icons-png.flaticon.com/128/9408/9408226.png",
  "https://cdn-icons-png.flaticon.com/128/9408/9408183.png",
  "https://cdn-icons-png.flaticon.com/128/9408/9408238.png"
];

const GIFS = [
  "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbXp1ZGI4Z3J5aG56Y3h6Z3I1Z3I1Z3I1Z3I1Z3I1Z3I1/3o7TKSjRrfIPjeiVyM/giphy.gif",
  "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbXp1ZGI4Z3J5aG56Y3h6Z3I1Z3I1Z3I1Z3I1Z3I1Z3I1/26AHONQ79FdWZhAI0/giphy.gif",
  "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbXp1ZGI4Z3J5aG56Y3h6Z3I1Z3I1Z3I1Z3I1Z3I1Z3I1/l0HlHJGHe3yAMhdQY/giphy.gif"
];

const MOCK_STORIES: Story[] = [
  { id: 1, user: "Momo", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Momo", image: "https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80", viewed: false, time: "2h ago" },
  { id: 2, user: "Coco", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Coco", image: "https://images.unsplash.com/photo-1492633423870-43d1cd2775eb?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80", viewed: false, time: "4h ago" },
  { id: 3, user: "Bubu", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Bubu", image: "https://images.unsplash.com/photo-1543852786-1cf6624b9987?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80", viewed: true, time: "6h ago" }
];

const MOCK_CONTACTS: Contact[] = [
  { id: 101, name: "Alice Wonderland", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Alice", bio: "Curiouser and curiouser!" },
  { id: 102, name: "Bob Builder", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Bob", bio: "Can we fix it?" },
  { id: 103, name: "Charlie Chaplin", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Charlie", bio: "Silence is golden." }
];

const MOCK_REPLIES = ["Okay! ðŸ‘", "Haha really? ðŸ˜‚", "Sounds good.", "Send me a pic!", "Wait, what?", "Nice!", "I'll check it out.", "ðŸ‘€"];

// --- Helper Functions ---
const formatTime = (date: Date): string => {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
};

const generateId = (): number => {
  return Date.now() + Math.floor(Math.random() * 1000);
};

const groupMessagesByDate = (messages: Message[]): Record<string, Message[]> => {
  const groups: Record<string, Message[]> = {};
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  
  messages.forEach(message => {
    let dateString: string;
    const messageDate = new Date(message.id); // Using ID as timestamp
    
    if (messageDate.toDateString() === today.toDateString()) {
      dateString = "Today";
    } else if (messageDate.toDateString() === yesterday.toDateString()) {
      dateString = "Yesterday";
    } else {
      dateString = messageDate.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }
    
    if (!groups[dateString]) {
      groups[dateString] = [];
    }
    groups[dateString].push(message);
  });
  
  return groups;
};

const calculateWinner = (squares: string[]): string | null => {
  const lines = [
    [0, 1, 2], [3, 4, 5], [6, 7, 8],
    [0, 3, 6], [1, 4, 7], [2, 5, 8],
    [0, 4, 8], [2, 4, 6]
  ];
  
  for (const [a, b, c] of lines) {
    if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) {
      return squares[a];
    }
  }
  return null;
};

const sanitizeText = (text: string): string => {
  return text
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
};

// --- Initial Data ---
const INITIAL_CHATS: Chat[] = [
  {
    id: 0,
    name: "Saved Messages",
    avatar: "saved",
    type: "private",
    role: "owner",
    lastMessage: "Note to self...",
    time: "Just now",
    unread: 0,
    online: true,
    archived: false,
    muted: false,
    blocked: false,
    pinnedMessageId: null,
    messages: [
      { id: 1, text: "Meeting notes: Buy milk", sender: "me", time: "10:00 AM", status: 'read', type: 'text', reactions: [] }
    ]
  },
  {
    id: 99,
    name: "BotFather",
    avatar: "bot",
    type: "bot",
    role: "bot",
    verified: true,
    lastMessage: "I can help you create and manage Telegram bots.",
    time: "Yesterday",
    unread: 0,
    online: true,
    archived: false,
    muted: false,
    blocked: false,
    pinnedMessageId: null,
    messages: [
      { id: 1, text: "I can help you create and manage Telegram bots. If you're new to the Bot API, please see the manual.\n\nYou can control me by sending these commands:\n\n/newbot - create a new bot\n/mybots - edit your bots", sender: "them", time: "Yesterday", status: 'read', reactions: [] }
    ]
  },
  {
    id: 1,
    name: "Momo ðŸŒ¸",
    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Momo",
    type: "private",
    role: "owner",
    lastMessage: "It's a secret! ||Don't tell anyone||",
    time: "10:42 AM",
    unread: 2,
    online: true,
    archived: false,
    muted: false,
    blocked: false,
    bio: "Cat lover | Designer ðŸŽ¨",
    mobile: "+1 234 567 890",
    lastSeen: "last seen recently",
    pinnedMessageId: null,
    messages: [
      { id: 1, text: "Hey! Are we still meeting?", sender: "them", time: "10:30 AM", status: 'read', reactions: [] },
      { id: 2, text: "Yes! I'm on my way ðŸš—", sender: "me", time: "10:32 AM", status: 'read', reactions: [{ emoji: "ðŸ”¥", count: 1, me: true }] },
      { id: 4, text: "It's a secret! ||Don't tell anyone||", sender: "them", time: "10:42 AM", status: 'read', reactions: [{ emoji: "â¤ï¸", count: 2, me: false }] }
    ]
  },
  {
    id: 10,
    name: "Design Team ðŸŽ¨",
    avatar: "group",
    type: "group",
    role: "member",
    members: 14,
    lastMessage: "Alice: New mockups are ready!",
    time: "11:00 AM",
    unread: 5,
    online: false,
    archived: false,
    muted: false,
    blocked: false,
    pinnedMessageId: null,
    messages: [
      { id: 1, text: "Guys, please check the Figma file", sender: "them", senderName: "Alice", time: "10:55 AM", status: 'read', reactions: [] },
      {
        id: 2,
        type: "poll",
        sender: "me",
        senderName: "Me",
        time: "10:56 AM",
        status: 'read',
        reactions: [],
        question: "When should we launch?",
        options: [
          { id: 1, text: "Monday", votes: 2, voted: false },
          { id: 2, text: "Wednesday", votes: 5, voted: true },
          { id: 3, text: "Friday", votes: 1, voted: false }
        ]
      }
    ]
  },
  {
    id: 11,
    name: "My Announcements ðŸ“¢",
    avatar: "channel",
    type: "channel",
    role: "admin",
    subscribers: "5.2K",
    description: "Official channel for my app updates and news.",
    link: "t.me/my_announcements",
    lastMessage: "Broadcast: New update live!",
    time: "9:00 AM",
    unread: 0,
    online: false,
    archived: false,
    muted: false,
    blocked: false,
    pinnedMessageId: null,
    messages: [
      { id: 1, text: "We just launched version 2.0! Enjoy.", sender: "me", time: "9:00 AM", status: 'read', reactions: [{ emoji: "ðŸ”¥", count: 152, me: true }], views: 4500 }
    ]
  },
  {
    id: 12,
    name: "Telegram Tips ðŸ’¡",
    avatar: "channel",
    type: "channel",
    role: "subscriber",
    subscribers: "125K",
    description: "Daily tips and tricks to get the most out of Telegram.",
    link: "t.me/telegram_tips",
    lastMessage: "Tip #45: Use folders",
    time: "Yesterday",
    unread: 1,
    online: false,
    archived: false,
    muted: true,
    blocked: false,
    pinnedMessageId: null,
    messages: [
      { id: 1, text: "Did you know you can organize chats into folders? Go to Settings > Folders.", sender: "them", time: "Yesterday", status: 'read', reactions: [{ emoji: "ðŸ‘", count: 1200, me: false }], views: 56000 }
    ]
  },
  {
    id: 2,
    name: "Coco ðŸ¥¥",
    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Coco",
    type: "private",
    role: "owner",
    lastMessage: "Sticker",
    time: "9:15 AM",
    unread: 0,
    online: false,
    archived: false,
    muted: false,
    blocked: false,
    bio: "Living life one coconut at a time",
    lastSeen: "last seen 2 hours ago",
    messages: [
      { id: 1, text: "Did you finish the design?", sender: "them", time: "9:00 AM", status: 'read', reactions: [] },
      { id: 2, text: "Almost done!", sender: "me", time: "9:10 AM", status: 'read', reactions: [] }
    ]
  }
];

// --- Components ---
interface AuthScreenProps {
  onLogin: () => void;
  darkMode: boolean;
}

const AuthScreen: React.FC<AuthScreenProps> = ({ onLogin, darkMode }) => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    
    if (!username.trim() || !password.trim()) {
      setError('Please enter both username and password');
      return;
    }

    if (username && password) {
      setIsLoading(true);
      // Simulate API call
      setTimeout(() => {
        setIsLoading(false);
        onLogin();
      }, 800);
    }
  };

  return (
    <div className={`h-full w-full flex items-center justify-center ${darkMode ? 'bg-[#0f0f0f]' : 'bg-gray-100'}`}>
      <div className={`w-full max-w-[400px] p-10 rounded-2xl shadow-xl flex flex-col items-center animate-login ${darkMode ? 'bg-[#1c1c1d] text-white' : 'bg-white text-gray-900'}`}>
        <div className="w-32 h-32 rounded-full flex items-center justify-center mb-6 bg-[#3390ec]">
          <Bot className="w-16 h-16 text-white" />
        </div>
        <h1 className="text-2xl font-bold mb-2">Sign in</h1>
        <p className={`text-center mb-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Please enter your username and password.</p>

        {error && (
          <div className="w-full mb-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg">
            <p className="text-red-500 text-sm text-center">{error}</p>
          </div>
        )}

        <form onSubmit={handleSubmit} className="w-full flex flex-col gap-6">
          <div className="relative group">
            <input
              type="text"
              id="username"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              className={`peer w-full border rounded-xl px-4 pt-5 pb-2 outline-none transition-colors ${darkMode ? 'bg-transparent border-gray-600 focus:border-[#3390ec]' : 'bg-transparent border-gray-300 focus:border-[#3390ec]'}`}
              required
              disabled={isLoading}
              aria-label="Username"
              aria-required="true"
            />
            <label
              htmlFor="username"
              className={`absolute left-4 top-3.5 text-gray-500 text-base transition-all duration-200 peer-focus:text-xs peer-focus:top-1 peer-focus:text-[#3390ec] ${username ? 'text-xs top-1' : ''}`}
            >
              Username
            </label>
          </div>

          <div className="relative group">
            <input
              type={showPassword ? "text" : "password"}
              id="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className={`peer w-full border rounded-xl px-4 pt-5 pb-2 pr-10 outline-none transition-colors ${darkMode ? 'bg-transparent border-gray-600 focus:border-[#3390ec]' : 'bg-transparent border-gray-300 focus:border-[#3390ec]'}`}
              required
              disabled={isLoading}
              aria-label="Password"
              aria-required="true"
            />
            <label
              htmlFor="password"
              className={`absolute left-4 top-3.5 text-gray-500 text-base transition-all duration-200 peer-focus:text-xs peer-focus:top-1 peer-focus:text-[#3390ec] ${password ? 'text-xs top-1' : ''}`}
            >
              Password
            </label>
            <button
              type="button"
              onClick={() => setShowPassword(!showPassword)}
              className="absolute right-3 top-4 text-gray-400 hover:text-gray-600"
              aria-label={showPassword ? "Hide password" : "Show password"}
              disabled={isLoading}
            >
              {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
            </button>
          </div>

          <button
            type="submit"
            disabled={isLoading}
            className={`w-full py-3 rounded-xl font-bold text-white transition-transform active:scale-95 flex justify-center items-center ${isLoading ? 'opacity-80 cursor-not-allowed' : ''}`}
            style={{ backgroundColor: "#3390ec" }}
            aria-label={isLoading ? "Logging in..." : "Log in"}
          >
            {isLoading ? (
              <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin" role="status">
                <span className="sr-only">Loading...</span>
              </div>
            ) : "Log In"}
          </button>
        </form>
      </div>
    </div>
  );
};

interface SpoilerTextProps {
  text: string;
}

const SpoilerText: React.FC<SpoilerTextProps> = ({ text }) => {
  const [revealed, setRevealed] = useState(false);

  if (typeof text !== 'string') {
    return <span>{String(text)}</span>;
  }

  const parts = text.split(/(\|\|.*?\|\|)/g);

  return (
    <span>
      {parts.map((part, i) => {
        if (part.startsWith('||') && part.endsWith('||')) {
          const content = part.slice(2, -2);
          const safeContent = sanitizeText(content);
          
          return (
            <span
              key={i}
              onClick={() => setRevealed(!revealed)}
              className={`cursor-pointer px-1 rounded transition-all duration-300 ${revealed ? '' : 'bg-gray-400 text-transparent blur-[4px] select-none'}`}
              aria-label={revealed ? "Spoiler revealed" : "Spoiler hidden"}
              role="button"
              tabIndex={0}
              onKeyDown={(e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                  e.preventDefault();
                  setRevealed(!revealed);
                }
              }}
              dangerouslySetInnerHTML={{ __html: safeContent }}
            />
          );
        }
        return <span key={i} dangerouslySetInnerHTML={{ __html: sanitizeText(part) }} />;
      })}
    </span>
  );
};

// --- Main App Component ---
export default function App() {
  // State Management
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [chats, setChats] = useState<Chat[]>(INITIAL_CHATS);
  const [activeChatId, setActiveChatId] = useState<number | null>(null);
  const [accentColor, setAccentColor] = useState<string>("#3390ec");

  const [sidebarView, setSidebarView] = useState<string>('main');
  const [activeFolder, setActiveFolder] = useState<string>('All');
  const [folders, setFolders] = useState<Folder[]>([
    { id: 'All', name: 'All', type: 'all', locked: false },
    { id: 'Personal', name: 'Personal', type: 'private', locked: true },
    { id: 'Work', name: 'Work', type: 'group', locked: false }
  ]);
  const [unlockedFolders, setUnlockedFolders] = useState<string[]>([]);
  const [isProfileOpen, setIsProfileOpen] = useState(false);
  const [isTyping, setIsTyping] = useState(false);
  const [darkMode, setDarkMode] = useState(false);

  const [searchQuery, setSearchQuery] = useState<string>("");
  const [chatSearchQuery, setChatSearchQuery] = useState<string>("");
  const [isChatSearchOpen, setIsChatSearchOpen] = useState<boolean>(false);

  const [myProfile, setMyProfile] = useState<Profile>({
    name: "Me",
    bio: "Available",
    phone: "+880 1700 000000",
    username: "@me_user"
  });
  const [isEditingProfile, setIsEditingProfile] = useState(false);
  const [tempProfile, setTempProfile] = useState<Profile>({ ...myProfile });

  const [inputText, setInputText] = useState<string>("");
  const [replyTo, setReplyTo] = useState<Message | null>(null);
  const [editingMessageId, setEditingMessageId] = useState<number | null>(null);
  const [isRecording, setIsRecording] = useState(false);
  const [showEmojiPicker, setShowEmojiPicker] = useState(false);
  const [pickerTab, setPickerTab] = useState<string>('emoji');
  const [isMainMenuOpen, setIsMainMenuOpen] = useState(false);
  const [isCreateMenuOpen, setIsCreateMenuOpen] = useState(false);
  const [isAttachMenuOpen, setIsAttachMenuOpen] = useState(false);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [selfDestructTime, setSelfDestructTime] = useState<number>(0);
  const [isTimerMenuOpen, setIsTimerMenuOpen] = useState(false);
  const [isScheduleMenuOpen, setIsScheduleMenuOpen] = useState(false);

  const [forwardState, setForwardState] = useState<{
    isOpen: boolean;
    messageId: number | null;
  }>({ isOpen: false, messageId: null });

  const [callState, setCallState] = useState<{
    isActive: boolean;
    isRinging: boolean;
    isConnected: boolean;
    type: string;
    startTime: number | null;
  }>({
    isActive: false,
    isRinging: false,
    isConnected: false,
    type: 'audio',
    startTime: null
  });

  const [pollModalOpen, setPollModalOpen] = useState(false);
  const [pollData, setPollData] = useState<{
    question: string;
    options: string[];
  }>({ question: '', options: ['', ''] });

  const [folderModalOpen, setFolderModalOpen] = useState(false);
  const [newFolderData, setNewFolderData] = useState<{
    name: string;
    type: string;
  }>({ name: '', type: 'all' });

  const [viewingStory, setViewingStory] = useState<Story | null>(null);
  const [storyProgress, setStoryProgress] = useState<number>(0);
  const [lockModalOpen, setLockModalOpen] = useState(false);
  const [passcodeInput, setPasscodeInput] = useState<string>("");
  const [targetFolder, setTargetFolder] = useState<string | null>(null);
  const [isDrawingOpen, setIsDrawingOpen] = useState(false);
  const [isQRModalOpen, setIsQRModalOpen] = useState(false);
  const [botCreationStep, setBotCreationStep] = useState<number>(0);

  const [msgContextMenu, setMsgContextMenu] = useState<{
    visible: boolean;
    x: number;
    y: number;
    messageId: number | null;
  }>({ visible: false, x: 0, y: 0, messageId: null });

  const [chatListContextMenu, setChatListContextMenu] = useState<{
    visible: boolean;
    x: number;
    y: number;
    chatId: number | null;
  }>({ visible: false, x: 0, y: 0, chatId: null });

  // Refs
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const contextRef = useRef<CanvasRenderingContext2D | null>(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [drawingColor, setDrawingColor] = useState<string>('#000000');

  // Computed values
  const activeChat = chats.find((c) => c.id === activeChatId);
  const pinnedMessage = activeChat?.messages.find(m => m.id === activeChat?.pinnedMessageId);

  // Style constants
  const bgClass = darkMode ? "bg-[#0f0f0f]" : "bg-white";
  const textClass = darkMode ? "text-white" : "text-gray-900";
  const subTextClass = darkMode ? "text-gray-400" : "text-gray-500";
  const sidebarBg = darkMode ? "bg-[#212121]" : "bg-white";
  const borderClass = darkMode ? "border-black" : "border-gray-200";
  const hoverClass = darkMode ? "hover:bg-[#2c2c2e]" : "hover:bg-gray-100";
  const myBubble = `text-white`;
  const theirBubble = darkMode ? "bg-[#212121] text-white" : "bg-white text-black";

  // Dynamic styles
  const dynamicStyles = useMemo(() => `
    .text-accent { color: ${accentColor} !important; }
    .bg-accent { background-color: ${accentColor} !important; }
    .border-accent { border-color: ${accentColor} !important; }
    .hover-text-accent:hover { color: ${accentColor} !important; }
    .hover-bg-accent:hover { background-color: ${accentColor} !important; }
    .group:focus-within .focus-within-text-accent { color: ${accentColor} !important; }
    .focus-within-border-accent:focus-within { border-color: ${accentColor} !important; }
    .selection-accent::selection { background-color: ${accentColor}; color: white; }
    
    @keyframes messagePopIn {
      from { opacity: 0; transform: translateY(10px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .animate-message {
      animation: messagePopIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
    
    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }
    .typing-dot {
      animation: typingBounce 1.4s infinite ease-in-out both;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    .toggle-checkbox:checked {
      right: 0;
      border-color: ${accentColor};
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: ${accentColor};
    }
    
    @keyframes loginFadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .animate-login { animation: loginFadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .animate-fade-in { animation: fadeIn 0.2s ease-in-out; }
    
    @keyframes zoomIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .animate-zoom-in { animation: zoomIn 0.2s ease-in-out; }
    
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .animate-scale-in { animation: scaleIn 0.15s ease-in-out; }
    
    .call-pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    .telegram-bg {
      background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,0.1) 1px, transparent 0);
      background-size: 20px 20px;
    }
  `, [accentColor]);

  // --- Helper Functions ---
  const getMessageText = useCallback((msg: Message): string => {
    if (typeof msg.text === 'string') return msg.text;
    return "Message";
  }, []);

  const formatPreviewMessage = useCallback((text: string, type?: string): string => {
    if (type === 'image') return 'ðŸ–¼ï¸ Photo';
    if (type === 'sticker') return 'Sticker';
    if (type === 'gif') return 'GIF';
    if (type === 'poll') return 'ðŸ“Š Poll';
    if (type === 'game') return 'ðŸŽ® Game';
    if (type === 'voice') return 'ðŸŽ¤ Voice message';

    if (typeof text !== 'string') return '';
    return text.replace(/\|\|.*?\|\|/g, "â–’â–’â–’â–’â–’");
  }, []);

  const getVisibleChats = useCallback((): Chat[] => {
    const currentFolderObj = folders.find(f => f.id === activeFolder);
    if (currentFolderObj?.locked && !unlockedFolders.includes(activeFolder)) {
      return [];
    }

    let filtered = chats;
    if (sidebarView === 'archived') {
      filtered = filtered.filter(c => c.archived);
    } else if (sidebarView === 'main') {
      filtered = filtered.filter(c => !c.archived);
      if (currentFolderObj && currentFolderObj.type !== 'all') {
        if (currentFolderObj.type === 'private') filtered = filtered.filter(c => c.type === 'private');
        else if (currentFolderObj.type === 'group') filtered = filtered.filter(c => c.type === 'group' || c.type === 'channel');
      }
    }
    if (searchQuery.trim()) {
      filtered = filtered.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase()));
    }
    return filtered;
  }, [chats, sidebarView, activeFolder, folders, unlockedFolders, searchQuery]);

  const visibleChats = getVisibleChats();

  // --- Event Handlers ---
  const handleOpenChat = useCallback((id: number) => {
    setActiveChatId(id);
    setChats(prev => prev.map(c => c.id === id ? { ...c, unread: 0 } : c));
    if (window.innerWidth < 768) setIsProfileOpen(false);
  }, []);

  const handleCloseChat = useCallback(() => {
    setActiveChatId(null);
  }, []);

  const handleSaveSettings = useCallback(() => {
    if (!tempProfile.name.trim()) {
      alert("Name cannot be empty");
      return;
    }
    setMyProfile(tempProfile);
    setIsEditingProfile(false);
  }, [tempProfile]);

  const updateChatWithNewMessage = useCallback((chatId: number, message: Message) => {
    setChats(prev => {
      const idx = prev.findIndex(c => c.id === chatId);
      if (idx === -1) return prev;
      
      const updated = {
        ...prev[idx],
        messages: [...prev[idx].messages, message],
        lastMessage: message.type === 'image' ? 'ðŸ–¼ï¸ Photo' :
          message.type === 'sticker' ? 'Sticker' :
            message.type === 'gif' ? 'GIF' :
              message.type === 'poll' ? 'ðŸ“Š Poll' :
                message.type === 'game' ? 'ðŸŽ® Game' :
                  message.type === 'voice' ? 'ðŸŽ¤ Voice message' :
                    message.text || '',
        time: message.time,
        archived: false
      };
      
      const newChats = [...prev];
      newChats.splice(idx, 1);
      newChats.unshift(updated);
      return newChats;
    });
  }, []);

  const handleSendMessage = useCallback((content: string = inputText, type: string = 'text', scheduled: boolean = false) => {
    if ((!content.trim() && !selectedFile && !isRecording) || activeChatId === null) {
      return;
    }

    if (editingMessageId) {
      setChats(prev => prev.map(c => {
        if (c.id === activeChatId) {
          return {
            ...c,
            messages: c.messages.map(m =>
              m.id === editingMessageId
                ? { ...m, text: content.trim(), isEdited: true }
                : m
            )
          };
        }
        return c;
      }));
      setEditingMessageId(null);
      setInputText("");
      return;
    }

    if (activeChatId === 99) {
      if (content === '/newbot') {
        setBotCreationStep(1);
        setTimeout(() => {
          updateChatWithNewMessage(99, {
            id: generateId(),
            text: "Alright, a new bot. How are we going to call it? Please choose a name for your bot.",
            sender: 'them',
            time: formatTime(new Date()),
            status: 'read',
            reactions: []
          });
        }, 500);
        setInputText("");
        return;
      } else if (botCreationStep === 1) {
        setBotCreationStep(2);
        setTimeout(() => {
          updateChatWithNewMessage(99, {
            id: generateId(),
            text: "Good. Now let's choose a username for your bot. It must end in `bot`. Like this, for example: TetrisBot or tetris_bot.",
            sender: 'them',
            time: formatTime(new Date()),
            status: 'read',
            reactions: []
          });
        }, 500);
        setInputText("");
        return;
      } else if (botCreationStep === 2) {
        const botName = content.trim();
        if (!botName) {
          alert("Bot name cannot be empty");
          return;
        }
        
        setBotCreationStep(0);
        const newBotId = generateId();
        const newBotChat: Chat = {
          id: newBotId,
          name: botName,
          avatar: "bot",
          type: "bot",
          role: "owner",
          verified: false,
          lastMessage: "Bot created",
          time: "Just now",
          unread: 0,
          online: true,
          blocked: false,
          archived: false,
          muted: false,
          pinnedMessageId: null,
          messages: [{
            id: 1,
            text: "/start",
            sender: "me",
            time: formatTime(new Date()),
            status: 'sent',
            reactions: []
          }]
        };
        
        setChats(prev => [newBotChat, ...prev]);

        setTimeout(() => {
          updateChatWithNewMessage(99, {
            id: generateId(),
            text: `Done! Congratulations on your new bot. You can find it at t.me/${botName}_bot.\n\nUse this token to access the HTTP API:\n${Math.random().toString(36).substring(2, 15)}`,
            sender: 'them',
            time: formatTime(new Date()),
            status: 'read',
            reactions: []
          });
        }, 500);
      }
    }

    const now = new Date();
    const timeString = formatTime(now);

    let messageContent = content.trim();
    let messageType = type;

    if (selectedFile) {
      messageContent = selectedFile.name;
      messageType = selectedFile.type.startsWith('image/') ? 'image' : 'file';
    } else if (isRecording) {
      messageContent = "Voice Message (0:05)";
      messageType = 'voice';
    }

    const newMessage: Message = {
      id: generateId(),
      text: messageContent,
      type: messageType,
      fileUrl: selectedFile && messageType === 'image' ? URL.createObjectURL(selectedFile) :
        (messageType === 'sticker' || messageType === 'gif' || messageType === 'image' ? content : undefined),
      sender: 'me',
      time: timeString,
      status: 'sent',
      reactions: [],
      replyTo: replyTo ? { ...replyTo } : undefined,
      expiresAt: selfDestructTime > 0 ? Date.now() + (selfDestructTime * 1000) + 2000 : undefined,
      selfDestructTime: selfDestructTime,
      gameState: messageType === 'game' ? {
        board: Array(9).fill(null),
        xIsNext: true,
        winner: null
      } : undefined,
      views: 1,
      isScheduled: scheduled,
      file: selectedFile || undefined
    };

    if (scheduled) {
      alert(`Message scheduled for delivery`);
    }

    updateChatWithNewMessage(activeChatId, newMessage);

    // Cleanup
    setInputText("");
    setReplyTo(null);
    setSelectedFile(null);
    setIsRecording(false);
    setShowEmojiPicker(false);
    setIsScheduleMenuOpen(false);
    setSelfDestructTime(0);

    // Simulate bot/contact response
    if (activeChat && activeChat.type === 'bot' && activeChat.id !== 99) {
      setTimeout(() => {
        updateChatWithNewMessage(activeChatId, {
          id: generateId(),
          text: `I received your message: "${messageContent}"`,
          sender: 'them',
          time: formatTime(new Date()),
          status: 'read',
          reactions: []
        });
        updateChatWithNewMessage(0, {
          id: generateId(),
          text: `[Forward from ${activeChat.name}] ${messageContent}`,
          sender: 'me',
          time: formatTime(new Date()),
          status: 'read',
          reactions: []
        });
      }, 1000);
    }

    // Simulate message status updates and typing indicators
    if (activeChatId !== 0 && activeChat && activeChat.type !== 'channel' && activeChat.type !== 'bot') {
      setTimeout(() => {
        setChats(prev => prev.map(c =>
          c.id === activeChatId
            ? { ...c, messages: c.messages.map(m => m.id === newMessage.id ? { ...m, status: 'read' } : m) }
            : c
        ));
      }, 1000);

      if (activeChat.type === 'private') {
        setTimeout(() => {
          setIsTyping(true);
        }, 1000);

        setTimeout(() => {
          setIsTyping(false);
          const replyText = MOCK_REPLIES[Math.floor(Math.random() * MOCK_REPLIES.length)];
          updateChatWithNewMessage(activeChatId, {
            id: generateId(),
            text: replyText,
            type: 'text',
            sender: 'them',
            time: formatTime(new Date()),
            status: 'read',
            reactions: []
          });
        }, 3000);
      }
    }
  }, [
    inputText,
    selectedFile,
    isRecording,
    activeChatId,
    editingMessageId,
    botCreationStep,
    updateChatWithNewMessage,
    activeChat,
    replyTo,
    selfDestructTime
  ]);

  const handleCreateFolder = useCallback(() => {
    if (!newFolderData.name.trim()) {
      alert("Folder name cannot be empty");
      return;
    }
    
    const newFolder: Folder = {
      id: newFolderData.name.toLowerCase().replace(/\s+/g, '-'),
      name: newFolderData.name,
      type: newFolderData.type as any,
      locked: false
    };
    
    if (folders.some(f => f.id === newFolder.id)) {
      alert("A folder with this name already exists");
      return;
    }
    
    setFolders(prev => [...prev, newFolder]);
    setFolderModalOpen(false);
    setNewFolderData({ name: '', type: 'all' });
  }, [newFolderData, folders]);

  const handleCreatePoll = useCallback(() => {
    const options = pollData.options.filter(o => o.trim() !== '');
    if (!pollData.question.trim()) {
      alert("Poll question cannot be empty");
      return;
    }
    if (options.length < 2) {
      alert("Poll must have at least 2 options");
      return;
    }
    
    const newMessage: Message = {
      id: generateId(),
      type: 'poll',
      sender: 'me',
      time: formatTime(new Date()),
      status: 'sent',
      question: pollData.question,
      options: options.map((opt, i) => ({
        id: i,
        text: opt,
        votes: 0,
        voted: false
      })),
      reactions: []
    };
    
    if (activeChatId) {
      updateChatWithNewMessage(activeChatId, newMessage);
    }
    setPollModalOpen(false);
    setPollData({ question: '', options: ['', ''] });
  }, [pollData, activeChatId, updateChatWithNewMessage]);

  const handleVote = useCallback((messageId: number, optionId: number) => {
    setChats(prev => prev.map(c => {
      if (c.id === activeChatId) {
        return {
          ...c,
          messages: c.messages.map(m => {
            if (m.id === messageId && m.type === 'poll' && m.options) {
              return {
                ...m,
                options: m.options.map(opt => {
                  if (opt.id === optionId && !opt.voted) {
                    return { ...opt, votes: opt.votes + 1, voted: true };
                  }
                  if (opt.voted && opt.id !== optionId) {
                    return { ...opt, votes: opt.votes - 1, voted: false };
                  }
                  return opt;
                })
              };
            }
            return m;
          })
        };
      }
      return c;
    }));
  }, [activeChatId]);

  const handleMuteToggle = useCallback(() => {
    setChats(prev => prev.map(c => c.id === activeChatId ? { ...c, muted: !c.muted } : c));
  }, [activeChatId]);

  const handleFolderClick = useCallback((folderId: string) => {
    const folder = folders.find(f => f.id === folderId);
    if (folder?.locked && !unlockedFolders.includes(folderId)) {
      setTargetFolder(folderId);
      setLockModalOpen(true);
    } else {
      setActiveFolder(folderId);
    }
  }, [folders, unlockedFolders]);

  const handleUnlockFolder = useCallback(() => {
    if (passcodeInput === "1234") {
      setUnlockedFolders(prev => [...prev, targetFolder!]);
      setActiveFolder(targetFolder!);
      setLockModalOpen(false);
      setPasscodeInput("");
    } else {
      alert("Incorrect passcode. Hint: 1234");
      setPasscodeInput("");
    }
  }, [passcodeInput, targetFolder]);

  const handleGameMove = useCallback((messageId: number, index: number) => {
    setChats(prev => prev.map(c => {
      if (c.id === activeChatId) {
        return {
          ...c,
          messages: c.messages.map(m => {
            if (m.id === messageId &&
              m.type === 'game' &&
              m.gameState &&
              !m.gameState.winner &&
              !m.gameState.board[index]) {
              const newBoard = [...m.gameState.board];
              newBoard[index] = m.gameState.xIsNext ? 'X' : 'O';
              const winner = calculateWinner(newBoard);
              return {
                ...m,
                gameState: {
                  board: newBoard,
                  xIsNext: !m.gameState.xIsNext,
                  winner
                }
              };
            }
            return m;
          })
        };
      }
      return c;
    }));
  }, [activeChatId]);

  const startDrawing = useCallback((e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {
    if (!canvasRef.current || !contextRef.current) return;

    const canvas = canvasRef.current;
    const rect = canvas.getBoundingClientRect();
    let offsetX: number, offsetY: number;

    if ('touches' in e) {
      offsetX = e.touches[0].clientX - rect.left;
      offsetY = e.touches[0].clientY - rect.top;
    } else {
      offsetX = e.nativeEvent.offsetX;
      offsetY = e.nativeEvent.offsetY;
    }

    contextRef.current.beginPath();
    contextRef.current.moveTo(offsetX, offsetY);
    setIsDrawing(true);
  }, []);

  const finishDrawing = useCallback(() => {
    if (!contextRef.current) return;
    contextRef.current.closePath();
    setIsDrawing(false);
  }, []);

  const draw = useCallback((e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {
    if (!isDrawing || !contextRef.current || !canvasRef.current) return;

    const canvas = canvasRef.current;
    const rect = canvas.getBoundingClientRect();
    let offsetX: number, offsetY: number;

    if ('touches' in e) {
      offsetX = e.touches[0].clientX - rect.left;
      offsetY = e.touches[0].clientY - rect.top;
    } else {
      offsetX = e.nativeEvent.offsetX;
      offsetY = e.nativeEvent.offsetY;
    }

    contextRef.current.lineTo(offsetX, offsetY);
    contextRef.current.stroke();
  }, [isDrawing]);

  const sendDrawing = useCallback(() => {
    if (!canvasRef.current) return;
    
    const image = canvasRef.current.toDataURL("image/png");
    handleSendMessage(image, 'image');
    setIsDrawingOpen(false);
    
    // Clear canvas
    if (contextRef.current) {
      contextRef.current.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
    }
  }, [handleSendMessage]);

  const startCall = useCallback((type: string) => {
    setCallState({
      isActive: true,
      isRinging: true,
      isConnected: false,
      type: type,
      startTime: null
    });
    
    setTimeout(() => {
      setCallState(prev => prev.isActive ? ({
        ...prev,
        isRinging: false,
        isConnected: true,
        startTime: Date.now()
      }) : prev);
    }, 3000);
  }, []);

  const endCall = useCallback(() => {
    setCallState({
      isActive: false,
      isRinging: false,
      isConnected: false,
      type: 'audio',
      startTime: null
    });
  }, []);

  const handleCreateChat = useCallback((type: 'group' | 'channel' | 'private') => {
    const id = generateId();
    const newChat: Chat = {
      id,
      name: type === 'channel' ? "New Channel" :
        (type === 'group' ? "New Group" : "New Chat"),
      avatar: type,
      type,
      role: 'admin',
      members: type === 'group' ? 1 : undefined,
      subscribers: type === 'channel' ? "1" : undefined,
      lastMessage: type === 'channel' ? "Channel created" : "Group created",
      time: "Just now",
      unread: 0,
      online: false,
      blocked: false,
      archived: false,
      muted: false,
      pinnedMessageId: null,
      messages: []
    };
    
    setChats(prev => [newChat, ...prev]);
    handleOpenChat(id);
    setIsCreateMenuOpen(false);
  }, [handleOpenChat]);

  const handleStartContactChat = useCallback((contact: Contact) => {
    const existing = chats.find(c => c.name === contact.name);
    if (existing) {
      handleOpenChat(existing.id);
    } else {
      const newChat: Chat = {
        id: generateId(),
        name: contact.name,
        avatar: contact.avatar,
        type: "private",
        role: 'owner',
        bio: contact.bio,
        lastMessage: "",
        time: "",
        unread: 0,
        online: false,
        blocked: false,
        archived: false,
        muted: false,
        pinnedMessageId: null,
        messages: []
      };
      
      setChats(prev => [newChat, ...prev]);
      handleOpenChat(newChat.id);
    }
    setSidebarView('main');
  }, [chats, handleOpenChat]);

  const handleForwardMessage = useCallback((targetChatId: number) => {
    if (!forwardState.messageId || !activeChatId || !activeChat) return;
    
    const originalMsg = activeChat.messages.find(m => m.id === forwardState.messageId);
    if (!originalMsg) return;
    
    const forwardedMsg = {
      ...originalMsg,
      id: generateId(),
      sender: 'me',
      isForwarded: true,
      time: formatTime(new Date()),
      status: 'sent',
      reactions: []
    };
    
    updateChatWithNewMessage(targetChatId, forwardedMsg);
    setForwardState({ isOpen: false, messageId: null });
    handleOpenChat(targetChatId);
  }, [forwardState.messageId, activeChatId, activeChat, updateChatWithNewMessage, handleOpenChat]);

  const handleMessageContextMenu = useCallback((e: React.MouseEvent, messageId: number) => {
    e.preventDefault();
    e.stopPropagation();
    setIsMainMenuOpen(false);
    setMsgContextMenu({
      visible: true,
      x: e.clientX,
      y: e.clientY,
      messageId
    });
  }, []);

  const handleMessageAction = useCallback((action: string, messageId: number) => {
    if (!activeChatId || !activeChat) return;

    switch (action) {
      case 'delete':
        setChats(prev => prev.map(c =>
          c.id === activeChatId
            ? { ...c, messages: c.messages.filter(m => m.id !== messageId) }
            : c
        ));
        break;
      case 'pin':
        setChats(prev => prev.map(c =>
          c.id === activeChatId
            ? { ...c, pinnedMessageId: c.pinnedMessageId === messageId ? null : messageId }
            : c
        ));
        break;
      case 'reply':
        const msg = activeChat.messages.find(m => m.id === messageId);
        if (msg) {
          setReplyTo(msg);
          inputRef.current?.focus();
        }
        break;
      case 'forward':
        setForwardState({ isOpen: true, messageId });
        break;
      case 'edit':
        const editMsg = activeChat.messages.find(m => m.id === messageId);
        if (editMsg && editMsg.sender === 'me') {
          setEditingMessageId(messageId);
          setInputText(editMsg.text || '');
          inputRef.current?.focus();
        } else {
          alert("You can only edit your own messages.");
        }
        break;
      case 'translate':
        setChats(prev => prev.map(c =>
          c.id === activeChatId
            ? {
              ...c,
              messages: c.messages.map(m =>
                m.id === messageId
                  ? { ...m, text: `[Translated] ${(m.text || '').split('').reverse().join('')}` }
                  : m
              )
            }
            : c
        ));
        break;
    }
    setMsgContextMenu(prev => ({ ...prev, visible: false }));
  }, [activeChatId, activeChat]);

  const handleChatAction = useCallback((action: string, chatId?: number) => {
    const id = chatId || chatListContextMenu.chatId;
    if (!id) return;

    setChats(prev => {
      const filteredChats = prev.filter(c => {
        if ((action === 'delete' || action === 'leave') && c.id === id) return false;
        return true;
      });

      return filteredChats.map(c => {
        if (c.id === id) {
          if (action === 'archive') return { ...c, archived: !c.archived };
          if (action === 'block') return { ...c, blocked: !c.blocked };
        }
        return c;
      });
    });

    setChatListContextMenu(prev => ({ ...prev, visible: false }));
    if (action === 'block' && isProfileOpen) setIsProfileOpen(true);
    if ((action === 'delete' || action === 'leave') && activeChatId === id) setActiveChatId(null);
  }, [chatListContextMenu.chatId, isProfileOpen, activeChatId]);

  const handleReactionClick = useCallback((emoji: string) => {
    if (!msgContextMenu.messageId || !activeChatId) return;

    setChats(prev => prev.map(c => {
      if (c.id === activeChatId) {
        return {
          ...c,
          messages: c.messages.map(m => {
            if (m.id === msgContextMenu.messageId) {
              const existingReaction = m.reactions?.find(r => r.emoji === emoji && r.me);
              let newReactions: EmojiReaction[] = [...(m.reactions || [])];

              if (existingReaction) {
                newReactions = newReactions
                  .map(r => r.emoji === emoji ? { ...r, count: r.count - 1, me: false } : r)
                  .filter(r => r.count > 0);
              } else {
                const existingEmojiReaction = newReactions.find(r => r.emoji === emoji);
                if (existingEmojiReaction) {
                  newReactions = newReactions.map(r =>
                    r.emoji === emoji ? { ...r, count: r.count + 1, me: true } : r
                  );
                } else {
                  newReactions.push({ emoji, count: 1, me: true });
                }
              }

              return { ...m, reactions: newReactions };
            }
            return m;
          })
        };
      }
      return c;
    }));

    setMsgContextMenu(prev => ({ ...prev, visible: false }));
  }, [msgContextMenu.messageId, activeChatId]);

  // --- Effects ---
  // Message expiration timer
  useEffect(() => {
    const interval = setInterval(() => {
      const now = Date.now();
      setChats(prevChats => {
        let changed = false;
        const newChats = prevChats.map(chat => {
          const hasExpired = chat.messages.some(msg => msg.expiresAt && now > msg.expiresAt);
          if (hasExpired) {
            changed = true;
            return {
              ...chat,
              messages: chat.messages.filter(msg => {
                if (msg.expiresAt && now > msg.expiresAt) {
                  // Revoke object URL if exists
                  if (msg.fileUrl && msg.fileUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(msg.fileUrl);
                  }
                  return false;
                }
                return true;
              })
            };
          }
          return chat;
        });
        return changed ? newChats : prevChats;
      });
    }, 1000);
    
    return () => clearInterval(interval);
  }, []);

  // Story progress effect
  useEffect(() => {
    let storyTimer: NodeJS.Timeout;
    
    if (viewingStory) {
      setStoryProgress(0);
      const duration = 5000;
      const interval = 50;
      const step = 100 / (duration / interval);

      storyTimer = setInterval(() => {
        setStoryProgress(prev => {
          if (prev >= 100) {
            clearInterval(storyTimer);
            setViewingStory(null);
            return 0;
          }
          return prev + step;
        });
      }, interval);
    }
    
    return () => {
      if (storyTimer) clearInterval(storyTimer);
    };
  }, [viewingStory]);

  // Scroll to bottom on new messages
  useEffect(() => {
    if (activeChatId !== null && messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [chats, activeChatId, isTyping]);

  // Reset chat-specific states when chat changes
  useEffect(() => {
    setMsgContextMenu({ visible: false, x: 0, y: 0, messageId: null });
    setShowEmojiPicker(false);
    setIsAttachMenuOpen(false);
    setIsTimerMenuOpen(false);
    setIsScheduleMenuOpen(false);
    setReplyTo(null);
    setEditingMessageId(null);
    setIsChatSearchOpen(false);
    setChatSearchQuery("");
    setIsTyping(false);
    setBotCreationStep(0);
    setSelfDestructTime(0);
  }, [activeChatId]);

  // Canvas setup
  useEffect(() => {
    if (isDrawingOpen && canvasRef.current) {
      const canvas = canvasRef.current;
      canvas.width = canvas.offsetWidth * 2;
      canvas.height = canvas.offsetHeight * 2;
      const ctx = canvas.getContext('2d');
      if (ctx) {
        ctx.scale(2, 2);
        ctx.lineCap = 'round';
        ctx.strokeStyle = drawingColor;
        ctx.lineWidth = 3;
        contextRef.current = ctx;
      }
    }
  }, [isDrawingOpen, drawingColor]);

  // Global click handler
  useEffect(() => {
    const handleClick = () => {
      if (msgContextMenu.visible) setMsgContextMenu(prev => ({ ...prev, visible: false }));
      if (chatListContextMenu.visible) setChatListContextMenu(prev => ({ ...prev, visible: false }));
      if (isMainMenuOpen) setIsMainMenuOpen(false);
      if (isCreateMenuOpen) setIsCreateMenuOpen(false);
      if (showEmojiPicker) setShowEmojiPicker(false);
      if (isAttachMenuOpen) setIsAttachMenuOpen(false);
      if (isTimerMenuOpen) setIsTimerMenuOpen(false);
      if (isScheduleMenuOpen) setIsScheduleMenuOpen(false);
    };

    window.addEventListener('click', handleClick);
    return () => window.removeEventListener('click', handleClick);
  }, [
    msgContextMenu.visible,
    chatListContextMenu.visible,
    isMainMenuOpen,
    isCreateMenuOpen,
    showEmojiPicker,
    isAttachMenuOpen,
    isTimerMenuOpen,
    isScheduleMenuOpen
  ]);

  // Cleanup object URLs
  useEffect(() => {
    return () => {
      chats.forEach(chat => {
        chat.messages.forEach(msg => {
          if (msg.fileUrl && msg.fileUrl.startsWith('blob:')) {
            URL.revokeObjectURL(msg.fileUrl);
          }
        });
      });
    };
  }, [chats]);

  // --- Render ---
  if (!isAuthenticated) {
    return <AuthScreen onLogin={() => setIsAuthenticated(true)} darkMode={darkMode} />;
  }

  return (
    <div className={`font-sans h-[100dvh] overflow-hidden flex justify-center items-center ${darkMode ? 'bg-[#0f0f0f]' : 'bg-gray-200'} text-gray-800`}>
      <style>{dynamicStyles}</style>

      {/* Call Screen */}
      {callState.isActive && (
        <div className="fixed inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center text-white animate-fade-in">
          <div className="absolute top-10 left-10 flex items-center gap-2">
            <Shield className="w-5 h-5" />
            <span className="text-sm">End-to-end encrypted</span>
          </div>
          <img
            src={activeChat?.avatar}
            className="w-32 h-32 rounded-full mb-6 border-4 border-gray-700 object-cover"
            alt={activeChat?.name}
          />
          <h2 className="text-3xl font-bold mb-2">{activeChat?.name}</h2>
          <p className="text-gray-400 mb-12">{callState.isRinging ? "Ringing..." : "00:05"}</p>
          <div className="flex gap-16 items-center">
            <button className="p-4 bg-gray-700 rounded-full hover:bg-gray-600 transition">
              <Mic className="w-8 h-8" />
            </button>
            <button
              onClick={endCall}
              className="p-5 bg-red-500 rounded-full hover:bg-red-600 transition call-pulse"
            >
              <PhoneOff className="w-10 h-10 fill-current" />
            </button>
            <button className="p-4 bg-gray-700 rounded-full hover:bg-gray-600 transition">
              <VolumeX className="w-8 h-8" />
            </button>
          </div>
        </div>
      )}

      {/* Story Viewer */}
      {viewingStory && (
        <div className="fixed inset-0 z-[80] bg-black flex flex-col items-center justify-center animate-fade-in">
          <div className="absolute top-4 w-full px-4 flex gap-1">
            <div className="h-1 bg-white/30 flex-1 rounded overflow-hidden">
              <div
                className="h-full bg-white w-full transition-all duration-50"
                style={{ width: `${storyProgress}%` }}
              />
            </div>
          </div>
          <div className="absolute top-8 left-4 flex items-center gap-2 z-10">
            <img
              src={viewingStory.avatar}
              className="w-8 h-8 rounded-full border border-white"
              alt={viewingStory.user}
            />
            <div>
              <div className="text-white font-bold text-sm shadow-black drop-shadow-md">
                {viewingStory.user}
              </div>
              <div className="text-white/70 text-xs shadow-black drop-shadow-md">
                {viewingStory.time}
              </div>
            </div>
          </div>
          <button
            onClick={() => setViewingStory(null)}
            className="absolute top-8 right-4 text-white"
            aria-label="Close story"
          >
            <X size={24} />
          </button>
          <img
            src={viewingStory.image}
            className="max-h-full max-w-full object-contain"
            alt={`${viewingStory.user}'s story`}
          />
          <div className="absolute inset-0 flex">
            <div className="flex-1" onClick={() => setViewingStory(null)} />
            <div className="flex-1" onClick={() => setViewingStory(null)} />
          </div>
        </div>
      )}

      {/* QR Code Modal */}
      {isQRModalOpen && (
        <div className="fixed inset-0 z-[90] bg-black/50 flex items-center justify-center p-4 animate-fade-in">
          <div className={`w-80 rounded-2xl shadow-2xl ${sidebarBg} ${textClass} p-8 flex flex-col items-center animate-zoom-in relative`}>
            <button
              onClick={() => setIsQRModalOpen(false)}
              className="absolute top-4 right-4 text-gray-400"
              aria-label="Close QR code"
            >
              <X size={20} />
            </button>
            <div className="w-20 h-20 rounded-full mb-4 border-4 border-white shadow-lg overflow-hidden">
              <div className="w-full h-full flex items-center justify-center text-2xl font-bold bg-accent text-white">
                {myProfile.name[0]}
              </div>
            </div>
            <h3 className="font-bold text-xl mb-1">{myProfile.name}</h3>
            <p className="text-gray-500 text-sm mb-6">{myProfile.username}</p>
            <div className="bg-white p-4 rounded-xl">
              <QrCode size={150} color="black" />
            </div>
            <p className="text-xs text-gray-400 mt-4 text-center">Scan this code to add me on Telegram</p>
          </div>
        </div>
      )}

      {/* Lock Modal */}
      {lockModalOpen && (
        <div className="fixed inset-0 z-[90] bg-black/50 flex items-center justify-center p-4">
          <div className={`w-[90%] max-w-sm rounded-xl shadow-2xl ${sidebarBg} ${textClass} p-6 flex flex-col items-center`}>
            <div className="w-16 h-16 rounded-2xl bg-gray-100 flex items-center justify-center mb-4">
              <Lock className="w-8 h-8 text-gray-500" />
            </div>
            <h3 className="font-bold text-lg mb-2">Folder Locked</h3>
            <p className="text-sm text-gray-500 mb-4 text-center">Enter passcode to view this folder</p>
            <input
              autoFocus
              type="password"
              value={passcodeInput}
              onChange={(e) => setPasscodeInput(e.target.value)}
              className={`w-full p-2 text-center text-xl tracking-widest rounded-xl border outline-none mb-4 ${darkMode ? 'bg-gray-800 border-gray-600' : 'bg-gray-50'}`}
              maxLength={4}
              placeholder="1234"
              onKeyDown={(e) => {
                if (e.key === 'Enter') {
                  handleUnlockFolder();
                }
              }}
            />
            <div className="flex gap-2 w-full">
              <button
                onClick={() => {
                  setLockModalOpen(false);
                  setPasscodeInput("");
                }}
                className="flex-1 py-2 text-gray-500 hover:bg-gray-100 rounded-xl transition duration-200"
              >
                Cancel
              </button>
              <button
                onClick={handleUnlockFolder}
                className="flex-1 py-2 text-white rounded-xl font-bold bg-accent transition duration-200"
              >
                Unlock
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Drawing Modal */}
      {isDrawingOpen && (
        <div className="fixed inset-0 z-[90] bg-black/80 flex flex-col items-center justify-center p-4 animate-fade-in">
          <div className="bg-white rounded-xl overflow-hidden shadow-2xl flex flex-col relative w-full max-w-lg animate-zoom-in">
            <div className="absolute top-2 right-2 flex gap-2">
              <button
                onClick={() => {
                  const ctx = canvasRef.current?.getContext('2d');
                  if (ctx) {
                    ctx.clearRect(0, 0, canvasRef.current!.width, canvasRef.current!.height);
                  }
                }}
                className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition duration-200"
                aria-label="Clear drawing"
              >
                <Trash2 size={20} className="text-red-500" />
              </button>
              <button
                onClick={() => setIsDrawingOpen(false)}
                className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition duration-200"
                aria-label="Close drawing"
              >
                <X size={20} />
              </button>
            </div>
            <canvas
              ref={canvasRef}
              onMouseDown={startDrawing}
              onMouseUp={finishDrawing}
              onMouseMove={draw}
              onMouseLeave={finishDrawing}
              onTouchStart={startDrawing}
              onTouchMove={draw}
              onTouchEnd={finishDrawing}
              className="cursor-crosshair bg-white w-full h-[400px] touch-none"
              aria-label="Drawing canvas"
            />
            <div className="p-4 bg-gray-100 flex justify-between items-center">
              <div className="flex gap-2">
                {['#000000', '#ef4444', '#22c55e', '#3b82f6', '#eab308'].map(color => (
                  <button
                    key={color}
                    onClick={() => setDrawingColor(color)}
                    className={`w-8 h-8 rounded-full border-2 transition duration-200 ${drawingColor === color ? 'border-gray-600 scale-110' : 'border-white'}`}
                    style={{ backgroundColor: color }}
                    aria-label={`Select ${color} color`}
                  />
                ))}
              </div>
              <button
                onClick={sendDrawing}
                className="px-6 py-2 bg-accent text-white rounded-full font-bold hover:opacity-90 flex items-center gap-2 transition duration-200"
              >
                <Send size={18} /> Send
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Poll Modal */}
      {pollModalOpen && (
        <div className="fixed inset-0 z-[70] bg-black/50 flex items-center justify-center p-4 animate-fade-in">
          <div className={`w-[90%] max-w-sm rounded-xl shadow-2xl ${sidebarBg} ${textClass} animate-zoom-in`}>
            <div className={`p-4 border-b flex justify-between items-center ${borderClass}`}>
              <h3 className="font-bold">Create Poll</h3>
              <button onClick={() => setPollModalOpen(false)} aria-label="Close poll modal">
                <X className={subTextClass} />
              </button>
            </div>
            <div className="p-4 flex flex-col gap-3">
              <input
                type="text"
                placeholder="Ask a question..."
                value={pollData.question}
                onChange={(e) => setPollData({ ...pollData, question: e.target.value })}
                className={`w-full p-2 rounded-lg border outline-none ${darkMode ? 'bg-gray-800 border-gray-600' : 'bg-gray-50'}`}
                aria-label="Poll question"
              />
              {pollData.options.map((opt, i) => (
                <input
                  key={i}
                  type="text"
                  placeholder={`Option ${i + 1}`}
                  value={opt}
                  onChange={(e) => {
                    const newOpts = [...pollData.options];
                    newOpts[i] = e.target.value;
                    setPollData({ ...pollData, options: newOpts });
                  }}
                  className={`w-full p-2 rounded-lg border outline-none ${darkMode ? 'bg-gray-800 border-gray-600' : 'bg-gray-50'}`}
                  aria-label={`Poll option ${i + 1}`}
                />
              ))}
              <button
                onClick={() => setPollData({ ...pollData, options: [...pollData.options, ''] })}
                className="text-sm flex items-center gap-1 font-medium hover-bg-accent w-max px-2 py-1 rounded-lg text-accent transition duration-200"
                aria-label="Add option"
              >
                <Plus size={16} /> Add Option
              </button>
              <button
                onClick={handleCreatePoll}
                className="w-full text-white py-2 rounded-lg mt-2 font-bold hover:opacity-90 bg-accent transition duration-200"
                aria-label="Create poll"
              >
                Create
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Folder Modal */}
      {folderModalOpen && (
        <div className="fixed inset-0 z-[70] bg-black/50 flex items-center justify-center p-4 animate-fade-in">
          <div className={`w-[90%] max-w-sm rounded-xl shadow-2xl ${sidebarBg} ${textClass} animate-zoom-in`}>
            <div className={`p-4 border-b flex justify-between items-center ${borderClass}`}>
              <h3 className="font-bold">New Folder</h3>
              <button onClick={() => setFolderModalOpen(false)} aria-label="Close folder modal">
                <X className={subTextClass} />
              </button>
            </div>
            <div className="p-4 flex flex-col gap-3">
              <input
                type="text"
                value={newFolderData.name}
                onChange={e => setNewFolderData({ ...newFolderData, name: e.target.value })}
                className={`w-full p-2 rounded-lg border outline-none ${darkMode ? 'bg-gray-800 border-gray-600' : 'bg-gray-50'}`}
                placeholder="Folder Name"
                aria-label="Folder name"
              />
              <div className="flex gap-2">
                {['all', 'private', 'group'].map(type => (
                  <button
                    key={type}
                    onClick={() => setNewFolderData({ ...newFolderData, type })}
                    className={`flex-1 py-2 text-xs font-bold rounded-lg border capitalize transition duration-200 ${newFolderData.type === type ? 'text-white bg-accent border-accent' : `${darkMode ? 'border-gray-600' : 'border-gray-200'} ${subTextClass}`}`}
                    aria-label={`Select ${type} folder type`}
                  >
                    {type}
                  </button>
                ))}
              </div>
              <button
                onClick={handleCreateFolder}
                className="w-full text-white py-2 rounded-lg mt-4 font-bold hover:opacity-90 bg-accent transition duration-200"
                aria-label="Create folder"
              >
                Create Folder
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Main App Container */}
      <div className={`w-full h-full relative flex shadow-2xl overflow-hidden md:max-w-[1600px] md:h-full ${sidebarBg}`}>

        {/* Left Sidebar */}
        <div
          className={`
            w-full absolute md:relative inset-0 md:inset-auto 
            md:w-[380px] lg:w-[420px] h-full flex flex-col 
            z-20 ${borderClass} ${sidebarBg} 
            transition-transform duration-300 ease-[cubic-bezier(0.25,1,0.5,1)]
            md:border-r
            ${activeChatId !== null ? '-translate-x-1/4 md:translate-x-0' : 'translate-x-0'}
          `}
        >
          <header className="px-3 pt-2 pb-2 flex flex-col gap-2 shrink-0 relative">
            <div className="flex gap-3 items-center w-full">
              {/* Menu / Search Row */}
              {sidebarView !== 'main' ? (
                <button
                  onClick={() => setSidebarView('main')}
                  className={`p-2 rounded-full transition duration-200 ${hoverClass} ${subTextClass}`}
                  aria-label="Go back"
                >
                  <ArrowLeft className="w-6 h-6" />
                </button>
              ) : (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setIsMainMenuOpen(!isMainMenuOpen);
                  }}
                  className={`p-2 rounded-full transition duration-200 ${isMainMenuOpen ? 'bg-gray-100 text-accent' : subTextClass} ${hoverClass}`}
                  aria-label="Open menu"
                  aria-expanded={isMainMenuOpen}
                >
                  <Menu className="w-6 h-6" />
                </button>
              )}
              <div className={`flex-1 rounded-full flex items-center px-4 py-2 border border-transparent focus-within-border-accent transition duration-200 group ${darkMode ? 'bg-[#1c1c1d] border-gray-700' : 'bg-gray-100'}`}>
                <Search className="w-5 h-5 text-gray-400 group-focus-text-accent" />
                <input
                  type="text"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Search"
                  className={`bg-transparent border-none outline-none text-sm ml-2 w-full placeholder-gray-500 min-w-0 ${textClass}`}
                  aria-label="Search chats"
                />
              </div>
            </div>

            {sidebarView === 'main' && (
              <>
                <div className="flex gap-4 overflow-x-auto no-scrollbar mt-1 pb-2 px-1">
                  <div className="flex flex-col items-center gap-1 min-w-[60px] cursor-pointer group">
                    <div className="w-14 h-14 rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 group-hover:border-accent transition duration-200">
                      <Plus size={24} />
                    </div>
                    <span className="text-xs text-gray-500 font-medium">My Story</span>
                  </div>
                  {MOCK_STORIES.map(story => (
                    <div
                      key={story.id}
                      onClick={() => setViewingStory(story)}
                      className="flex flex-col items-center gap-1 min-w-[60px] cursor-pointer"
                      role="button"
                      tabIndex={0}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                          setViewingStory(story);
                        }
                      }}
                    >
                      <div className={`w-14 h-14 rounded-full p-[2px] transition duration-200 transform hover:scale-105 ${story.viewed ? 'bg-gray-300' : 'bg-accent'}`}>
                        <img
                          src={story.avatar}
                          className={`w-full h-full rounded-full border-2 ${darkMode ? 'border-[#1c1c1d]' : 'border-white'} object-cover`}
                          alt={story.user}
                        />
                      </div>
                      <span className={`text-xs font-medium ${textClass}`}>{story.user}</span>
                    </div>
                  ))}
                </div>

                <div className="flex items-center gap-4 overflow-x-auto no-scrollbar mt-1 border-b border-gray-100 pb-0 px-2">
                  {folders.map(folder => (
                    <button
                      key={folder.id}
                      onClick={() => handleFolderClick(folder.id)}
                      className={`pb-2 text-sm font-medium transition duration-200 whitespace-nowrap flex items-center gap-1 border-b-2 ${activeFolder === folder.id ? 'border-accent text-accent' : `border-transparent ${subTextClass} hover:text-gray-700`}`}
                      aria-label={`${folder.name} folder${folder.locked ? ' (locked)' : ''}`}
                    >
                      {folder.locked && <Lock size={12} />}
                      {folder.name}
                    </button>
                  ))}
                  <button
                    onClick={() => setFolderModalOpen(true)}
                    className={`pb-2 ${subTextClass} ${hoverClass} rounded-t-lg px-2 transition duration-200`}
                    aria-label="Create new folder"
                  >
                    <FolderPlus size={16} />
                  </button>
                </div>
              </>
            )}

            {/* Main Menu */}
            {isMainMenuOpen && sidebarView === 'main' && (
              <div
                className={`absolute top-14 left-4 rounded-xl shadow-[0_10px_20px_rgba(0,0,0,0.15)] border w-64 py-2 z-50 animate-scale-in origin-top-left flex flex-col ${sidebarBg} ${borderClass}`}
                onClick={(e) => e.stopPropagation()}
                role="menu"
                aria-label="Main menu"
              >
                <button
                  onClick={() => {
                    handleOpenChat(0);
                    setIsMainMenuOpen(false);
                  }}
                  className={`flex items-center gap-4 px-4 py-2.5 transition duration-200 text-[15px] ${hoverClass} ${textClass}`}
                  role="menuitem"
                >
                  <Bookmark className="w-5 h-5 text-gray-500" /> Saved Messages
                </button>
                <button
                  onClick={() => {
                    setSidebarView('archived');
                    setIsMainMenuOpen(false);
                  }}
                  className={`flex items-center gap-4 px-4 py-2.5 transition duration-200 text-[15px] ${hoverClass} ${textClass}`}
                  role="menuitem"
                >
                  <Archive className="w-5 h-5 text-gray-500" /> Archived Chats
                </button>
                <button
                  onClick={() => {
                    setSidebarView('contacts');
                    setIsMainMenuOpen(false);
                  }}
                  className={`flex items-center gap-4 px-4 py-2.5 transition duration-200 text-[15px] ${hoverClass} ${textClass}`}
                  role="menuitem"
                >
                  <Users className="w-5 h-5 text-gray-500" /> Contacts
                </button>
                <button
                  onClick={() => {
                    setSidebarView('settings');
                    setIsMainMenuOpen(false);
                  }}
                  className={`flex items-center gap-4 px-4 py-2.5 transition duration-200 text-[15px] ${hoverClass} ${textClass}`}
                  role="menuitem"
                >
                  <Settings className="w-5 h-5 text-gray-500" /> Settings
                </button>
                <button
                  onClick={() => setDarkMode(!darkMode)}
                  className={`flex items-center gap-4 px-4 py-2.5 transition duration-200 text-[15px] ${hoverClass} ${textClass}`}
                  role="menuitem"
                >
                  {darkMode ? <Sun className="w-5 h-5 text-yellow-500" /> : <Moon className="w-5 h-5 text-gray-500" />}
                  {darkMode ? "Light Mode" : "Night Mode"}
                </button>
              </div>
            )}

            {/* Create Button */}
            <button
              onClick={(e) => {
                e.stopPropagation();
                setIsCreateMenuOpen(!isCreateMenuOpen);
              }}
              className={`absolute bottom-6 right-6 w-14 h-14 bg-accent text-white rounded-full flex items-center justify-center shadow-lg hover:opacity-90 hover:scale-105 transition duration-200 z-50`}
              aria-label="Create new chat"
              aria-expanded={isCreateMenuOpen}
            >
              <Edit2 className="w-6 h-6" />
            </button>

            {/* Create Menu */}
            {isCreateMenuOpen && (
              <div
                className={`absolute bottom-24 right-6 rounded-xl shadow-xl border w-48 py-2 z-50 animate-scale-in origin-bottom-right flex flex-col ${sidebarBg} ${borderClass}`}
                onClick={(e) => e.stopPropagation()}
                role="menu"
                aria-label="Create menu"
              >
                <button
                  onClick={() => handleCreateChat('group')}
                  className={`flex items-center gap-3 px-4 py-2.5 transition duration-200 text-[15px] ${hoverClass} ${textClass}`}
                  role="menuitem"
                >
                  <Users className="w-4 h-4 text-gray-500" /> New Group
                </button>
                <button
                  onClick={() => handleCreateChat('channel')}
                  className={`flex items-center gap-3 px-4 py-2.5 transition duration-200 text-[15px] ${hoverClass} ${textClass}`}
                  role="menuitem"
                >
                  <Megaphone className="w-4 h-4 text-gray-500" /> New Channel
                </button>
                <button
                  onClick={() => {
                    setSidebarView('contacts');
                    setIsCreateMenuOpen(false);
                  }}
                  className={`flex items-center gap-3 px-4 py-2.5 transition duration-200 text-[15px] ${hoverClass} ${textClass}`}
                  role="menuitem"
                >
                  <UserPlus className="w-4 h-4 text-gray-500" /> New Chat
                </button>
              </div>
            )}
          </header>

          {/* Chat List */}
          <div className="flex-1 overflow-y-auto no-scrollbar">
            {sidebarView === 'main' || sidebarView === 'archived' ? (
              <>
                {visibleChats.length === 0 && (
                  <div className="flex flex-col items-center justify-center h-40 text-gray-400">
                    {activeFolder === 'Personal' && folders.find(f => f.id === 'Personal')?.locked && !unlockedFolders.includes('Personal') ? (
                      <div className="text-center">
                        <Lock size={40} className="mx-auto mb-2 opacity-50" />
                        <p>This folder is locked</p>
                      </div>
                    ) : (
                      <p>No chats found</p>
                    )}
                  </div>
                )}
                {visibleChats.map((chat) => (
                  <div
                    key={chat.id}
                    onClick={() => handleOpenChat(chat.id)}
                    onContextMenu={(e) => {
                      e.preventDefault();
                      setChatListContextMenu({
                        visible: true,
                        x: e.clientX,
                        y: e.clientY,
                        chatId: chat.id
                      });
                    }}
                    className={`flex items-center gap-3 px-3 py-2 cursor-pointer transition duration-200 select-none ${activeChatId === chat.id ? 'bg-accent text-white' : hoverClass}`}
                    role="button"
                    tabIndex={0}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' || e.key === ' ') {
                        handleOpenChat(chat.id);
                      }
                    }}
                    aria-label={`Chat with ${chat.name}${chat.unread > 0 ? `, ${chat.unread} unread messages` : ''}`}
                  >
                    <div className="relative shrink-0">
                      {chat.id === 0 ? (
                        <div className="w-12 h-12 rounded-full flex items-center justify-center bg-accent">
                          <Bookmark className="w-6 h-6 text-white" />
                        </div>
                      ) : chat.id === 99 ? (
                        <div className="w-12 h-12 rounded-full flex items-center justify-center bg-blue-500">
                          <Bot className="w-6 h-6 text-white" />
                        </div>
                      ) : chat.avatar === 'group' ? (
                        <div className="w-12 h-12 rounded-full bg-orange-400 flex items-center justify-center">
                          <Users className="w-6 h-6 text-white" />
                        </div>
                      ) : chat.avatar === 'channel' ? (
                        <div className="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center">
                          <Megaphone className="w-6 h-6 text-white" />
                        </div>
                      ) : (
                        <img
                          src={chat.avatar}
                          className="w-12 h-12 rounded-full bg-gray-200 object-cover"
                          alt={chat.name}
                        />
                      )}
                      {chat.online && (
                        <div
                          className={`absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 ${activeChatId === chat.id ? 'bg-white border-accent' : 'bg-green-500 border-white'}`}
                          aria-label="Online"
                        />
                      )}
                    </div>
                    <div className={`flex-1 min-w-0 border-b pb-2 ml-1 h-full flex flex-col justify-center ${borderClass} ${activeChatId === chat.id ? 'border-transparent' : ''}`}>
                      <div className="flex justify-between items-baseline">
                        <h3 className={`font-semibold text-[15px] truncate flex items-center gap-1 min-w-0 ${activeChatId === chat.id ? 'text-white' : textClass}`}>
                          {chat.name}
                          {chat.blocked && <Ban className="w-3 h-3 text-red-500" aria-label="Blocked" />}
                          {chat.muted && <VolumeX className="w-3 h-3 opacity-50" aria-label="Muted" />}
                          {chat.verified && <CheckCircle size={12} className="text-blue-500 fill-white" aria-label="Verified" />}
                        </h3>
                        <span className={`text-xs ${activeChatId === chat.id ? 'text-white/80' : subTextClass}`}>
                          {chat.time}
                        </span>
                      </div>
                      <div className="flex justify-between items-center mt-0.5">
                        <p className={`text-[14px] truncate flex-1 min-w-0 ${activeChatId === chat.id ? 'text-white/80' : subTextClass}`}>
                          {formatPreviewMessage(chat.lastMessage, chat.messages[0]?.type)}
                        </p>
                        {chat.unread > 0 && (
                          <div
                            className={`min-w-[20px] h-5 px-1.5 text-xs font-bold rounded-full flex items-center justify-center ml-2 ${activeChatId === chat.id ? 'bg-white text-accent' : 'text-white'}`}
                            style={activeChatId !== chat.id ? { backgroundColor: '#c4c9cc' } : {}}
                            aria-label={`${chat.unread} unread messages`}
                          >
                            {chat.unread}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </>
            ) : sidebarView === 'contacts' ? (
              <div className="p-2">
                <div className={`px-4 py-2 text-sm font-bold ${subTextClass} uppercase`}>Contacts</div>
                {MOCK_CONTACTS.map(contact => (
                  <div
                    key={contact.id}
                    onClick={() => handleStartContactChat(contact)}
                    className={`flex items-center gap-3 px-3 py-2 cursor-pointer rounded-lg ${hoverClass}`}
                    role="button"
                    tabIndex={0}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' || e.key === ' ') {
                        handleStartContactChat(contact);
                      }
                    }}
                    aria-label={`Contact ${contact.name}`}
                  >
                    <img
                      src={contact.avatar}
                      className="w-10 h-10 rounded-full bg-gray-200"
                      alt={contact.name}
                    />
                    <div>
                      <h3 className={`font-medium ${textClass}`}>{contact.name}</h3>
                      <p className={`text-xs ${subTextClass}`}>{contact.bio}</p>
                    </div>
                  </div>
                ))}
              </div>
            ) : sidebarView === 'settings' ? (
              <div className="p-0">
                <div className="flex flex-col items-center py-6 border-b border-gray-200">
                  <div className="w-24 h-24 rounded-full flex items-center justify-center text-white text-3xl font-bold mb-3 bg-accent">
                    {myProfile.name[0]}
                  </div>
                  {isEditingProfile ? (
                    <div className="flex flex-col gap-2 w-3/4">
                      <input
                        type="text"
                        value={tempProfile.name}
                        onChange={e => setTempProfile({ ...tempProfile, name: e.target.value })}
                        className="border p-1 rounded"
                        aria-label="Edit name"
                      />
                      <input
                        type="text"
                        value={tempProfile.bio}
                        onChange={e => setTempProfile({ ...tempProfile, bio: e.target.value })}
                        className="border p-1 rounded text-sm"
                        aria-label="Edit bio"
                      />
                      <div className="flex gap-2 justify-center mt-2">
                        <button
                          onClick={handleSaveSettings}
                          className="bg-blue-500 text-white px-3 py-1 rounded text-sm"
                          aria-label="Save profile"
                        >
                          Save
                        </button>
                        <button
                          onClick={() => setIsEditingProfile(false)}
                          className="bg-gray-300 px-3 py-1 rounded text-sm"
                          aria-label="Cancel editing"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  ) : (
                    <>
                      <h2 className={`text-xl font-bold ${textClass}`}>{myProfile.name}</h2>
                      <p className={subTextClass}>{myProfile.phone}</p>
                      <p className={`text-sm mt-1 ${textClass}`}>"{myProfile.bio}"</p>
                      <button
                        onClick={() => {
                          setTempProfile(myProfile);
                          setIsEditingProfile(true);
                        }}
                        className="mt-3 text-sm flex items-center gap-1 text-accent"
                        aria-label="Edit profile"
                      >
                        <Edit2 size={14} /> Edit Profile
                      </button>
                    </>
                  )}
                </div>
                <div className="p-4 border-b border-gray-100">
                  <div className={`text-xs font-bold ${subTextClass} uppercase mb-2`}>Accent Color</div>
                  <div className="flex gap-2 justify-center">
                    {ACCENT_COLORS.map(color => (
                      <button
                        key={color.value}
                        onClick={() => setAccentColor(color.value)}
                        className={`w-8 h-8 rounded-full border-2 transition duration-200 ${accentColor === color.value ? 'border-gray-600 scale-110' : 'border-transparent'}`}
                        style={{ backgroundColor: color.value }}
                        aria-label={`Select ${color.name} color`}
                      />
                    ))}
                  </div>
                </div>
                <div className="p-2">
                  <div className={`flex items-center gap-4 px-4 py-3 ${hoverClass} cursor-pointer`}>
                    <Bell className="w-5 h-5 text-gray-500" />
                    <span className={textClass}>Notifications</span>
                  </div>
                  <div className={`flex items-center gap-4 px-4 py-3 ${hoverClass} cursor-pointer`}>
                    <Lock className="w-5 h-5 text-gray-500" />
                    <span className={textClass}>Privacy and Security</span>
                  </div>
                  <div
                    className={`flex items-center gap-4 px-4 py-3 ${hoverClass} cursor-pointer`}
                    onClick={() => setIsQRModalOpen(true)}
                    role="button"
                    tabIndex={0}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' || e.key === ' ') {
                        setIsQRModalOpen(true);
                      }
                    }}
                  >
                    <QrCode className="w-5 h-5 text-gray-500" />
                    <span className={textClass}>QR Code</span>
                  </div>
                </div>
              </div>
            ) : null}
          </div>
        </div>

        {/* Main Chat Area */}
        <div className={`flex-1 flex flex-col relative bg-[#0e1621] ${activeChatId === null ? 'hidden md:flex' : 'flex'}`}>
          {activeChat ? (
            <>
              {/* Chat Header */}
              <header className={`px-4 py-2 flex items-center justify-between shadow-sm z-10 shrink-0 h-[60px] ${sidebarBg}`}>
                <div
                  className="flex items-center gap-4 flex-1 cursor-pointer min-w-0"
                  onClick={() => setIsProfileOpen(!isProfileOpen)}
                  role="button"
                  tabIndex={0}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                      setIsProfileOpen(!isProfileOpen);
                    }
                  }}
                  aria-label={`Open ${activeChat.name} profile`}
                >
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      handleCloseChat();
                    }}
                    className="md:hidden text-gray-500"
                    aria-label="Close chat"
                  >
                    <ArrowLeft />
                  </button>
                  {activeChatId === 0 ? (
                    <div className="w-10 h-10 rounded-full flex items-center justify-center bg-accent flex-shrink-0">
                      <Bookmark className="text-white w-5 h-5" />
                    </div>
                  ) : activeChat.id === 99 ? (
                    <div className="w-10 h-10 rounded-full flex items-center justify-center bg-blue-500 flex-shrink-0">
                      <Bot className="text-white w-5 h-5" />
                    </div>
                  ) : activeChat.avatar === 'group' ? (
                    <div className="w-10 h-10 rounded-full bg-orange-400 flex items-center justify-center flex-shrink-0">
                      <Users className="w-5 h-5 text-white" />
                    </div>
                  ) : activeChat.avatar === 'channel' ? (
                    <div className="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0">
                      <Megaphone className="w-5 h-5 text-white" />
                    </div>
                  ) : (
                    <img
                      src={activeChat.avatar}
                      className="w-10 h-10 rounded-full object-cover flex-shrink-0"
                      alt={activeChat.name}
                    />
                  )}
                  <div className="flex flex-col min-w-0">
                    <h2 className={`font-bold text-[16px] leading-tight truncate ${textClass}`}>
                      {activeChat.name}
                      {activeChat.verified && (
                        <CheckCircle size={12} className="text-blue-500 inline-block ml-1 fill-white" aria-label="Verified" />
                      )}
                    </h2>
                    {activeChatId !== 0 && (
                      <span className={`text-[13px] truncate ${activeChat.online ? 'text-accent' : 'text-gray-500'}`}>
                        {activeChat.blocked ? (
                          <span className="text-red-500 font-bold">Blocked</span>
                        ) : isTyping ? (
                          'typing...'
                        ) : activeChat.type === 'bot' ? (
                          'bot'
                        ) : activeChat.type === 'group' ? (
                          `${activeChat.members} members`
                        ) : activeChat.type === 'channel' ? (
                          `${activeChat.subscribers} subscribers`
                        ) : activeChat.online ? (
                          'online'
                        ) : (
                          activeChat.lastSeen || 'last seen recently'
                        )}
                      </span>
                    )}
                  </div>
                </div>
                <div className="flex gap-4 text-gray-500 items-center flex-shrink-0">
                  {isChatSearchOpen ? (
                    <div className="flex items-center bg-gray-100 rounded-full px-3 py-1">
                      <input
                        autoFocus
                        value={chatSearchQuery}
                        onChange={(e) => setChatSearchQuery(e.target.value)}
                        className="bg-transparent outline-none text-sm w-32"
                        placeholder="Search..."
                        aria-label="Search in chat"
                      />
                      <button onClick={() => setIsChatSearchOpen(false)} aria-label="Close search">
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  ) : (
                    <button
                      onClick={() => setIsChatSearchOpen(true)}
                      className={`hover-text-accent`}
                      aria-label="Search in chat"
                    >
                      <Search className="w-5 h-5" />
                    </button>
                  )}
                  <button
                    onClick={() => startCall('audio')}
                    className={`hover-text-accent`}
                    aria-label="Start audio call"
                  >
                    <Phone className="w-5 h-5" />
                  </button>
                  <button
                    onClick={() => setIsProfileOpen(!isProfileOpen)}
                    className={`hover-text-accent hidden md:block`}
                    aria-label="Open profile"
                  >
                    <Info className="w-5 h-5" />
                  </button>
                  <button className={`hover-text-accent`} aria-label="More options">
                    <MoreVertical className="w-5 h-5" />
                  </button>
                </div>
              </header>

              {/* Pinned Message */}
              {pinnedMessage && (
                <div className={`px-4 py-2 border-b flex items-center justify-between gap-3 text-sm cursor-pointer z-10 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'}`}>
                  <div className="flex items-center gap-3 overflow-hidden min-w-0">
                    <div className="w-0.5 h-8 rounded-full bg-accent flex-shrink-0" />
                    <div className="flex flex-col min-w-0">
                      <span className="font-semibold text-xs text-accent">Pinned Message</span>
                      <span className={`truncate ${subTextClass} text-xs`}>
                        {getMessageText(pinnedMessage)}
                      </span>
                    </div>
                  </div>
                  <button
                    onClick={() => handleMessageAction('pin', pinnedMessage.id)}
                    aria-label="Unpin message"
                  >
                    <X className="w-4 h-4 text-gray-400" />
                  </button>
                </div>
              )}

              {/* Messages Container */}
              <div className="flex-1 overflow-y-auto p-2 relative bg-[#99ba92]">
                <div
                  className="absolute inset-0 opacity-40 pointer-events-none telegram-bg"
                  style={{ backgroundColor: darkMode ? '#0f0f0f' : '#7a8c76' }}
                />
                <div className="relative z-0 max-w-3xl mx-auto flex flex-col justify-end min-h-full pb-2">
                  {Object.entries(groupMessagesByDate(activeChat.messages)).map(([date, msgs]) => (
                    <div key={date}>
                      <div className="flex justify-center my-2 sticky top-2 z-10">
                        <span className="bg-black/20 text-white text-xs px-2 py-0.5 rounded-full backdrop-blur-sm">
                          {date}
                        </span>
                      </div>
                      {msgs
                        .filter(m => !chatSearchQuery || (typeof m.text === 'string' && m.text.toLowerCase().includes(chatSearchQuery.toLowerCase())))
                        .map((msg) => {
                          const isMe = msg.sender === 'me';
                          return (
                            <div
                              key={msg.id}
                              onContextMenu={(e) => handleMessageContextMenu(e, msg.id)}
                              className={`flex w-full ${isMe ? 'justify-end' : 'justify-start'} mb-1 group animate-message`}
                            >
                              <div
                                className={`relative max-w-[85%] px-3 py-1.5 shadow-sm text-[15px] rounded-lg ${isMe ? `${myBubble} rounded-tr-none bg-accent` : `${theirBubble} rounded-tl-none`}`}
                                style={isMe && darkMode ? { backgroundColor: '#766ac8' } : {}}
                              >
                                {!isMe && activeChat.type === 'group' && (
                                  <div className="text-xs text-[#e17076] font-semibold mb-0.5">
                                    {msg.senderName || activeChat.name}
                                  </div>
                                )}
                                {msg.isForwarded && (
                                  <div className="text-xs font-medium mb-1 flex items-center gap-1 text-accent">
                                    <Forward size={12} /> Forwarded message
                                  </div>
                                )}
                                {msg.replyTo && (
                                  <div
                                    className={`mb-1 pl-2 border-l-2 text-xs opacity-80 cursor-pointer border-accent`}
                                    style={isMe ? { borderColor: 'rgba(255,255,255,0.6)' } : {}}
                                  >
                                    <div
                                      className={`font-semibold`}
                                      style={{ color: isMe ? 'white' : accentColor }}
                                    >
                                      {msg.replyTo.sender === 'me' ? 'You' : activeChat.name}
                                    </div>
                                    <div className="truncate">{msg.replyTo.text}</div>
                                  </div>
                                )}

                                {msg.selfDestructTime && msg.selfDestructTime > 0 && (
                                  <div className="flex items-center gap-1 text-xs text-red-500 mb-1 font-bold">
                                    <Flame size={12} className="animate-pulse" /> Self-destructing
                                  </div>
                                )}

                                {/* Message Content */}
                                {msg.type === 'image' && msg.fileUrl ? (
                                  <img
                                    src={msg.fileUrl}
                                    className="rounded-lg mb-1 max-w-full max-h-64 object-cover"
                                    alt="Shared image"
                                  />
                                ) : msg.type === 'sticker' ? (
                                  <img
                                    src={msg.fileUrl}
                                    className="w-32 h-32 mb-1"
                                    alt="Sticker"
                                  />
                                ) : msg.type === 'gif' ? (
                                  <img
                                    src={msg.fileUrl}
                                    className="rounded-lg mb-1 max-w-full max-h-48 object-cover"
                                    alt="GIF"
                                  />
                                ) : msg.type === 'poll' ? (
                                  <div className="min-w-[200px] sm:min-w-[250px]">
                                    <div className="font-bold mb-2">{msg.question}</div>
                                    <div className="flex flex-col gap-2">
                                      {msg.options?.map(opt => (
                                        <button
                                          key={opt.id}
                                          onClick={() => handleVote(msg.id, opt.id)}
                                          className={`relative overflow-hidden w-full text-left px-3 py-2 rounded border transition ${opt.voted ? 'border-accent' : 'border-transparent bg-black/5 hover:bg-black/10'}`}
                                          aria-label={`Vote for ${opt.text}`}
                                        >
                                          {opt.voted && (
                                            <div
                                              className="absolute inset-0 opacity-20 bg-accent transition-all duration-300"
                                              style={{
                                                width: `${(opt.votes / Math.max(1, (msg.options?.reduce((a, b) => a + b.votes, 0) || 0))) * 100}%`
                                              }}
                                            />
                                          )}
                                          <div className="relative flex justify-between z-10">
                                            <span>{opt.text}</span>
                                            {opt.voted && <CheckCircle size={16} className="text-accent" />}
                                          </div>
                                          <div className="relative z-10 text-xs opacity-70 mt-1">
                                            {Math.round((opt.votes / Math.max(1, (msg.options?.reduce((a, b) => a + b.votes, 0) || 0))) * 100)}% ({opt.votes})
                                          </div>
                                        </button>
                                      ))}
                                    </div>
                                    <div className="text-xs opacity-60 mt-2">
                                      {msg.options?.reduce((a, b) => a + b.votes, 0) || 0} votes
                                    </div>
                                  </div>
                                ) : msg.type === 'game' ? (
                                  <div className="min-w-[200px] flex flex-col items-center p-2 bg-black/5 rounded">
                                    <div className="font-bold mb-2 flex items-center gap-2">
                                      <Gamepad2 size={16} /> Tic Tac Toe
                                    </div>
                                    <div className="grid grid-cols-3 gap-1">
                                      {msg.gameState?.board.map((cell, i) => (
                                        <button
                                          key={i}
                                          onClick={() => handleGameMove(msg.id, i)}
                                          disabled={!!cell || !!msg.gameState?.winner}
                                          className="w-12 h-12 bg-white rounded flex items-center justify-center text-xl font-bold border border-gray-200 text-black"
                                          aria-label={`Make move at position ${i + 1}`}
                                        >
                                          {cell}
                                        </button>
                                      ))}
                                    </div>
                                    <div className="mt-2 text-xs font-bold">
                                      {msg.gameState?.winner ? `Winner: ${msg.gameState.winner}!` : `Next: ${msg.gameState?.xIsNext ? 'X' : 'O'}`}
                                    </div>
                                  </div>
                                ) : (
                                  <div className="mr-8 pb-1 inline-block break-words selection-accent">
                                    <SpoilerText text={getMessageText(msg)} />
                                  </div>
                                )}

                                {/* Message Metadata */}
                                <div className="float-right flex items-center gap-1 ml-2 mt-2 select-none h-3 relative top-0.5">
                                  {msg.isEdited && (
                                    <span className={`text-[10px] ${subTextClass}`}>edited</span>
                                  )}
                                  <span className={`text-[11px] ${isMe ? 'text-green-800/60' : 'text-gray-400'} ${darkMode && isMe ? 'text-gray-300' : ''}`}>
                                    {msg.time.split(' ')[0]}
                                  </span>
                                  {isMe && (
                                    msg.status === 'read' ? (
                                      <CheckCheck className={`w-3.5 h-3.5 ${darkMode ? 'text-blue-300' : 'text-[#53bdeb]'}`} aria-label="Read" />
                                    ) : (
                                      <Check className="w-3.5 h-3.5 text-gray-400" aria-label="Sent" />
                                    )
                                  )}
                                  {activeChat.type === 'channel' && msg.views && msg.views > 0 && (
                                    <span className="flex items-center gap-0.5 text-[10px] text-gray-400 ml-1">
                                      <Eye size={10} /> {msg.views > 1000 ? (msg.views / 1000).toFixed(1) + 'k' : msg.views}
                                    </span>
                                  )}
                                </div>

                                {/* Reactions */}
                                {msg.reactions && msg.reactions.length > 0 && (
                                  <div className={`absolute -bottom-5 ${isMe ? 'right-0' : 'left-0'} flex gap-1 z-10`}>
                                    {msg.reactions.map((r, i) => (
                                      <button
                                        key={i}
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          handleReactionClick(r.emoji);
                                        }}
                                        className="bg-white border px-1.5 rounded-full text-xs shadow-sm text-black"
                                        aria-label={`${r.emoji} reaction, ${r.count} ${r.me ? 'including you' : ''}`}
                                      >
                                        {r.emoji} {r.count > 1 && r.count}
                                      </button>
                                    ))}
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })}
                    </div>
                  ))}

                  {/* Typing Indicator */}
                  {isTyping && (
                    <div className="flex items-center gap-1 px-4 py-2 bg-white w-max rounded-lg rounded-tl-none shadow-sm ml-2 animate-message">
                      <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot" />
                      <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot" />
                      <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot" />
                    </div>
                  )}

                  <div ref={messagesEndRef} />
                </div>
              </div>

              {/* Message Input */}
              {activeChat.blocked ? (
                <div className={`p-4 text-center border-t ${sidebarBg} ${borderClass}`}>
                  <div className="text-red-500 font-medium">You blocked this user</div>
                  <button
                    onClick={() => handleChatAction('block', activeChat.id)}
                    className="text-sm mt-1 hover:underline text-accent"
                    aria-label="Unblock user"
                  >
                    Unblock
                  </button>
                </div>
              ) : activeChat.type === 'channel' && activeChat.role !== 'admin' ? (
                <div className={`p-3 border-t flex justify-center ${sidebarBg} ${borderClass}`}>
                  <button
                    onClick={handleMuteToggle}
                    className={`px-8 py-2 rounded-lg text-sm font-medium uppercase transition ${activeChat.muted ? 'text-accent bg-blue-50' : 'text-gray-500 hover:bg-gray-100'}`}
                    aria-label={activeChat.muted ? 'Unmute channel' : 'Mute channel'}
                  >
                    {activeChat.muted ? 'Unmute' : 'Mute'}
                  </button>
                </div>
              ) : (
                <div className={`px-2 py-2 z-10 max-w-[100%] mx-auto w-full md:px-[10%] ${sidebarBg} relative`}>
                  {/* Editing Message Indicator */}
                  {editingMessageId && (
                    <div className={`flex items-center justify-between px-4 py-2 border-l-2 mb-2 border-accent ${darkMode ? 'bg-gray-800' : 'bg-gray-50'}`}>
                      <div className="flex flex-col text-sm ml-2">
                        <span className="font-semibold flex items-center gap-1 text-accent">
                          <Edit3 size={14} /> Edit Message
                        </span>
                        <span className="text-gray-500 truncate">
                          {chats.find(c => c.id === activeChatId)?.messages.find(m => m.id === editingMessageId)?.text}
                        </span>
                      </div>
                      <button
                        onClick={() => {
                          setEditingMessageId(null);
                          setInputText("");
                        }}
                        aria-label="Cancel editing"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  )}

                  {/* Reply Indicator */}
                  {replyTo && (
                    <div className={`flex items-center justify-between px-4 py-2 border-l-2 mb-2 border-accent ${darkMode ? 'bg-gray-800' : 'bg-gray-50'}`}>
                      <div className="flex flex-col text-sm ml-2">
                        <span className="font-semibold text-accent">
                          Reply to {replyTo.sender === 'me' ? 'You' : activeChat.name}
                        </span>
                        <span className="text-gray-500 truncate">{replyTo.text}</span>
                      </div>
                      <button onClick={() => setReplyTo(null)} aria-label="Cancel reply">
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  )}

                  {/* Attach Menu */}
                  {isAttachMenuOpen && (
                    <div
                      className={`absolute bottom-16 left-2 w-48 rounded-xl shadow-xl border py-2 z-50 animate-scale-in flex flex-col ${sidebarBg} ${borderClass}`}
                      onClick={(e) => e.stopPropagation()}
                    >
                      <button
                        onClick={() => {
                          fileInputRef.current?.click();
                          setIsAttachMenuOpen(false);
                        }}
                        className={`flex items-center gap-3 px-4 py-2.5 transition text-[15px] ${hoverClass} ${textClass}`}
                        aria-label="Attach photo or video"
                      >
                        <ImageIcon className="w-5 h-5 text-blue-500" /> Photo or Video
                      </button>
                      <button
                        onClick={() => {
                          setIsDrawingOpen(true);
                          setIsAttachMenuOpen(false);
                        }}
                        className={`flex items-center gap-3 px-4 py-2.5 transition text-[15px] ${hoverClass} ${textClass}`}
                        aria-label="Draw"
                      >
                        <PenTool className="w-5 h-5 text-orange-500" /> Draw
                      </button>
                      <button
                        onClick={() => {
                          handleSendMessage('', 'game');
                          setIsAttachMenuOpen(false);
                        }}
                        className={`flex items-center gap-3 px-4 py-2.5 transition text-[15px] ${hoverClass} ${textClass}`}
                        aria-label="Send game"
                      >
                        <Gamepad2 className="w-5 h-5 text-purple-500" /> Game
                      </button>
                      <button
                        className={`flex items-center gap-3 px-4 py-2.5 transition text-[15px] ${hoverClass} ${textClass}`}
                        aria-label="Attach file"
                      >
                        <Film className="w-5 h-5 text-blue-400" /> File
                      </button>
                      <button
                        onClick={() => {
                          setInputText(prev => prev + " ||spoiler||");
                          setIsAttachMenuOpen(false);
                          inputRef.current?.focus();
                        }}
                        className={`flex items-center gap-3 px-4 py-2.5 transition text-[15px] ${hoverClass} ${textClass}`}
                        aria-label="Add spoiler text"
                      >
                        <Eye className="w-5 h-5 text-gray-500" /> Spoiler
                      </button>
                      {activeChat.type === 'group' && (
                        <button
                          onClick={() => {
                            setPollModalOpen(true);
                            setIsAttachMenuOpen(false);
                          }}
                          className={`flex items-center gap-3 px-4 py-2.5 transition text-[15px] ${hoverClass} ${textClass}`}
                          aria-label="Create poll"
                        >
                          <BarChart2 className="w-5 h-5 text-yellow-500" /> Poll
                        </button>
                      )}
                    </div>
                  )}

                  {/* Timer Menu */}
                  {isTimerMenuOpen && (
                    <div
                      className={`absolute bottom-16 right-12 w-32 rounded-xl shadow-xl border py-2 z-50 animate-scale-in flex flex-col ${sidebarBg} ${borderClass}`}
                      onClick={(e) => e.stopPropagation()}
                    >
                      <div className="px-4 py-1 text-xs text-gray-500 font-bold uppercase">Self-Destruct</div>
                      {[0, 5, 10, 30, 60].map(time => (
                        <button
                          key={time}
                          onClick={() => {
                            setSelfDestructTime(time);
                            setIsTimerMenuOpen(false);
                          }}
                          className={`flex items-center justify-between px-4 py-2 text-sm ${hoverClass} ${textClass}`}
                          aria-label={`Set ${time === 0 ? 'off' : `${time} seconds`} self-destruct timer`}
                        >
                          <span>{time === 0 ? "Off" : `${time}s`}</span>
                          {selfDestructTime === time && <Check size={14} className="text-accent" />}
                        </button>
                      ))}
                    </div>
                  )}

                  {/* Schedule Menu */}
                  {isScheduleMenuOpen && (
                    <div
                      className={`absolute bottom-16 right-4 w-48 rounded-xl shadow-xl border py-2 z-50 animate-scale-in flex flex-col ${sidebarBg} ${borderClass}`}
                      onClick={(e) => e.stopPropagation()}
                    >
                      <button
                        onClick={() => handleSendMessage(inputText, 'text', true)}
                        className={`flex items-center gap-3 px-4 py-2.5 transition text-[15px] ${hoverClass} ${textClass}`}
                        aria-label="Schedule message"
                      >
                        <Clock size={16} /> Schedule Message
                      </button>
                      <button
                        onClick={() => handleSendMessage(inputText, 'text')}
                        className={`flex items-center gap-3 px-4 py-2.5 transition text-[15px] ${hoverClass} ${textClass}`}
                        aria-label="Send now"
                      >
                        <Send size={16} /> Send Now
                      </button>
                    </div>
                  )}

                  {/* Emoji Picker */}
                  {showEmojiPicker && (
                    <div
                      className={`absolute bottom-full left-0 mb-2 rounded-xl shadow-xl border w-80 h-72 overflow-hidden flex flex-col animate-scale-in z-50 ${sidebarBg} ${borderClass}`}
                      onClick={(e) => e.stopPropagation()}
                    >
                      <div className="flex border-b">
                        {['emoji', 'sticker', 'gif'].map(tab => (
                          <button
                            key={tab}
                            onClick={() => setPickerTab(tab)}
                            className={`flex-1 py-2 text-xs font-bold uppercase ${pickerTab === tab ? 'border-b-2 border-accent text-accent' : 'text-gray-500'}`}
                            aria-label={`${tab} picker`}
                          >
                            {tab}
                          </button>
                        ))}
                      </div>
                      <div className="flex-1 overflow-y-auto p-2">
                        {pickerTab === 'emoji' && (
                          <div className="grid grid-cols-8 gap-1">
                            {COMMON_EMOJIS.map((emoji) => (
                              <button
                                key={emoji}
                                onClick={() => {
                                  setInputText(prev => prev + emoji);
                                  inputRef.current?.focus();
                                }}
                                className={`w-8 h-8 flex items-center justify-center text-xl rounded-md transition ${hoverClass}`}
                                aria-label={`Add ${emoji} emoji`}
                              >
                                {emoji}
                              </button>
                            ))}
                          </div>
                        )}
                        {pickerTab === 'sticker' && (
                          <div className="grid grid-cols-3 gap-2">
                            {STICKERS.map((s, i) => (
                              <img
                                key={i}
                                src={s}
                                onClick={() => handleSendMessage(s, 'sticker')}
                                className="w-full h-auto cursor-pointer hover:scale-105 transition"
                                alt={`Sticker ${i + 1}`}
                              />
                            ))}
                          </div>
                        )}
                        {pickerTab === 'gif' && (
                          <div className="grid grid-cols-2 gap-2">
                            {GIFS.map((g, i) => (
                              <img
                                key={i}
                                src={g}
                                onClick={() => handleSendMessage(g, 'gif')}
                                className="w-full h-auto rounded cursor-pointer hover:scale-105 transition"
                                alt={`GIF ${i + 1}`}
                              />
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Input Controls */}
                  <div className="flex items-end gap-2 w-full">
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        setIsAttachMenuOpen(!isAttachMenuOpen);
                      }}
                      className={`p-3 text-gray-500 hover:bg-gray-100 rounded-full transition transform ${isAttachMenuOpen ? 'rotate-45' : ''}`}
                      aria-label="Attach file"
                      aria-expanded={isAttachMenuOpen}
                    >
                      <Paperclip className="w-6 h-6" />
                    </button>
                    <input
                      type="file"
                      ref={fileInputRef}
                      className="hidden"
                      onChange={(e) => {
                        if (e.target.files && e.target.files[0]) {
                          setSelectedFile(e.target.files[0]);
                          // Auto-send image files
                          if (e.target.files[0].type.startsWith('image/')) {
                            handleSendMessage('', 'image');
                          }
                        }
                      }}
                      accept="image/*,video/*"
                      aria-label="File input"
                    />
                    <div className={`flex-1 relative rounded-2xl flex items-center pr-2 ${darkMode ? 'bg-[#1c1c1d]' : 'bg-white'}`}>
                      <input
                        ref={inputRef}
                        type="text"
                        value={inputText}
                        onChange={(e) => setInputText(e.target.value)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            handleSendMessage();
                          }
                        }}
                        placeholder={editingMessageId ? "Edit message..." : "Message"}
                        className={`flex-1 bg-transparent border-none outline-none px-4 py-3 min-w-0 ${textClass}`}
                        aria-label="Message input"
                      />
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          setIsTimerMenuOpen(!isTimerMenuOpen);
                        }}
                        className={`p-1.5 rounded-full hover:bg-gray-200 transition ${selfDestructTime > 0 ? 'text-red-500' : 'text-gray-400'}`}
                        aria-label="Set self-destruct timer"
                        aria-expanded={isTimerMenuOpen}
                      >
                        <Clock size={18} />
                      </button>
                    </div>
                    {inputText || selectedFile ? (
                      <button
                        onClick={() => handleSendMessage()}
                        onContextMenu={(e) => {
                          e.preventDefault();
                          setIsScheduleMenuOpen(!isScheduleMenuOpen);
                        }}
                        className="p-3 hover:opacity-90 rounded-full text-white bg-accent"
                        aria-label={editingMessageId ? "Save edit" : "Send message"}
                      >
                        {editingMessageId ? <Check className="w-6 h-6" /> : <Send className="w-6 h-6 fill-current" />}
                      </button>
                    ) : (
                      <button
                        onClick={() => setIsRecording(!isRecording)}
                        className={`p-3 rounded-full ${isRecording ? 'text-red-500 bg-red-50' : 'text-gray-500'}`}
                        aria-label={isRecording ? "Stop recording" : "Record voice message"}
                      >
                        <Mic className="w-6 h-6" />
                      </button>
                    )}
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        setShowEmojiPicker(!showEmojiPicker);
                      }}
                      className={`p-3 transition rounded-full shrink-0 ${hoverClass} ${showEmojiPicker ? 'text-accent' : 'text-gray-400 hover:text-gray-500'}`}
                      aria-label="Open emoji picker"
                      aria-expanded={showEmojiPicker}
                    >
                      <Smile className="w-6 h-6" />
                    </button>
                  </div>
                </div>
              )}
            </>
          ) : (
            <div className={`flex-1 flex flex-col items-center justify-center ${darkMode ? 'bg-[#0f0f0f]' : 'bg-[#99ba92]'}`}>
              <div className="bg-black/20 text-white px-4 py-1 rounded-full text-sm">
                Select a chat to start messaging
              </div>
            </div>
          )}
        </div>

        {/* Right Profile Sidebar */}
        {isProfileOpen && activeChat && activeChatId !== 0 && (
          <div className={`fixed inset-0 z-50 md:relative md:z-20 md:w-[300px] border-l flex flex-col animate-scale-in ${sidebarBg} ${borderClass}`}>
            {/* Header */}
            <div className="flex items-center gap-4 p-4 border-b">
              <button onClick={() => setIsProfileOpen(false)} aria-label="Close profile">
                <X className="w-6 h-6 text-gray-500" />
              </button>
              <span className={`font-semibold ${textClass}`}>
                {activeChat.type === 'private' ? 'User Info' : activeChat.type === 'group' ? 'Group Info' : activeChat.type === 'bot' ? 'Bot Info' : 'Channel Info'}
              </span>
            </div>

            {/* Profile Content */}
            <div className="p-6 flex flex-col items-center border-b">
              <div className="w-24 h-24 rounded-full mb-4 overflow-hidden relative">
                {activeChat.avatar === 'group' ? (
                  <div className="w-full h-full bg-orange-400 flex items-center justify-center">
                    <Users className="w-12 h-12 text-white" />
                  </div>
                ) : activeChat.avatar === 'channel' ? (
                  <div className="w-full h-full bg-blue-500 flex items-center justify-center">
                    <Megaphone className="w-12 h-12 text-white" />
                  </div>
                ) : activeChat.type === 'bot' ? (
                  <div className="w-full h-full bg-blue-500 flex items-center justify-center">
                    <Bot className="w-12 h-12 text-white" />
                  </div>
                ) : (
                  <img
                    src={activeChat.avatar}
                    className="w-full h-full object-cover"
                    alt={activeChat.name}
                  />
                )}
              </div>
              <h2 className={`text-xl font-bold ${textClass}`}>
                {activeChat.name}
                {activeChat.verified && (
                  <CheckCircle size={16} className="text-blue-500 inline-block ml-1 fill-white" />
                )}
              </h2>
              <span className="text-gray-500 text-sm">
                {activeChat.online ? 'online' :
                  activeChat.type === 'private' ? 'last seen recently' :
                    activeChat.type === 'bot' ? 'bot' :
                      activeChat.type === 'group' ? `${activeChat.members} members` :
                        `${activeChat.subscribers} subscribers`}
              </span>
            </div>

            <div className="flex-1 overflow-y-auto">
              <div className="p-4 flex flex-col gap-4 border-b">
                {/* Channel Description */}
                {activeChat.type === 'channel' && activeChat.description && (
                  <div className="flex gap-4">
                    <Info className="w-6 h-6 text-gray-400 flex-shrink-0" />
                    <div>
                      <p className={textClass}>{activeChat.description}</p>
                      <span className="text-xs text-gray-400">Description</span>
                    </div>
                  </div>
                )}

                {/* Channel Link */}
                {activeChat.type === 'channel' && activeChat.link && (
                  <div className="flex gap-4 items-center cursor-pointer hover:bg-gray-50 p-1 -ml-1 rounded">
                    <LinkIcon className="w-6 h-6 text-gray-400 flex-shrink-0" />
                    <div className="flex-1 min-w-0">
                      <p className={`text-accent truncate`}>{activeChat.link}</p>
                      <span className="text-xs text-gray-400">Link</span>
                    </div>
                    <Copy className="w-4 h-4 text-gray-400" />
                  </div>
                )}

                {/* Notifications Toggle */}
                <div className="flex gap-4 items-center justify-between cursor-pointer">
                  <div className="flex gap-4 items-center">
                    <Bell className="w-6 h-6 text-gray-400" />
                    <span className={textClass}>Notifications</span>
                  </div>
                  <div
                    className={`w-10 h-5 rounded-full p-0.5 cursor-pointer transition-colors ${activeChat.muted ? 'bg-gray-300' : 'bg-accent'}`}
                    onClick={handleMuteToggle}
                    role="switch"
                    aria-checked={!activeChat.muted}
                    aria-label="Toggle notifications"
                  >
                    <div
                      className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${activeChat.muted ? '' : 'translate-x-5'}`}
                    />
                  </div>
                </div>

                {/* Block User (Private Chats) */}
                {activeChat.type === 'private' && (
                  <div
                    className="flex gap-4 items-center cursor-pointer mt-2"
                    onClick={() => handleChatAction('block', activeChat.id)}
                  >
                    <Ban className={`w-6 h-6 ${activeChat.blocked ? 'text-red-500' : 'text-gray-400'}`} />
                    <span className={activeChat.blocked ? 'text-red-500' : textClass}>
                      {activeChat.blocked ? 'Unblock User' : 'Block User'}
                    </span>
                  </div>
                )}

                {/* Leave Group/Channel */}
                {(activeChat.type === 'group' || activeChat.type === 'channel') && (
                  <div
                    className="flex gap-4 items-center cursor-pointer text-red-500 mt-2"
                    onClick={() => handleChatAction('leave', activeChat.id)}
                  >
                    <LogOut className="w-6 h-6" />
                    <span>Leave {activeChat.type === 'group' ? 'Group' : 'Channel'}</span>
                  </div>
                )}

                {/* Delete Chat */}
                <div
                  className="flex gap-4 items-center text-red-500 cursor-pointer"
                  onClick={() => handleChatAction('delete', activeChat.id)}
                >
                  <Trash2 className="w-6 h-6" />
                  <span>Delete Chat</span>
                </div>
              </div>

              {/* Shared Media */}
              <div className="p-2">
                <div className="flex items-center gap-2 px-2 py-2 text-sm font-semibold text-gray-500">
                  <Grid size={16} /> Shared Media
                </div>
                <div className="grid grid-cols-3 gap-1">
                  {activeChat.messages
                    .filter(m => m.type === 'image' && m.fileUrl)
                    .map(m => (
                      <img
                        key={m.id}
                        src={m.fileUrl}
                        className="w-full h-24 object-cover cursor-pointer hover:opacity-80"
                        alt="Shared media"
                      />
                    ))}
                  {activeChat.messages.filter(m => m.type === 'image').length === 0 && (
                    <div className="col-span-3 text-center text-xs text-gray-400 py-4">
                      No shared media
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
